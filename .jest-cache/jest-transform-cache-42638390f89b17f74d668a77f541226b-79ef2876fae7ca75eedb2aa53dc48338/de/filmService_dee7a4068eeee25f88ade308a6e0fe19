6703623ba5bfc99fc6452e4480fa351e
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getAvailableCountries = exports.getFilmsByIds = exports.getAvailableGenres = exports.getFilmsStats = exports.getRecentFilms = exports.getFilmsByGenre = exports.searchFilms = exports.deletePoster = exports.uploadPoster = exports.deleteFilm = exports.updateFilm = exports.getFilmById = exports.getAllFilms = exports.createFilm = void 0;
const firebase_1 = require("./firebase");
const firestore_1 = require("firebase/firestore");
const storage_1 = require("firebase/storage");
const helpers_1 = require("../utils/helpers");
const FILMS_COLLECTION = 'films';
const POSTERS_FOLDER = 'posters';
/**
 * Créer un nouveau film avec upload du poster
 */
const createFilm = async (data) => {
    try {
        let posterUrl;
        // Upload du poster si fourni
        if (data.poster) {
            posterUrl = await (0, exports.uploadPoster)(data.poster);
        }
        const filmData = {
            titre: data.titre,
            realisateur: data.realisateur,
            pays: data.pays,
            duree: data.duree,
            annee: data.annee,
            synopsis: data.synopsis,
            posterUrl,
            genre: data.genre,
            createdAt: new Date(),
            updatedAt: new Date(),
        };
        const docRef = await (0, firestore_1.addDoc)((0, firestore_1.collection)(firebase_1.db, FILMS_COLLECTION), filmData);
        return {
            id: docRef.id,
            ...filmData,
        };
    }
    catch (error) {
        console.error('Erreur lors de la création du film:', error);
        throw error;
    }
};
exports.createFilm = createFilm;
/**
 * Récupérer tous les films
 */
const getAllFilms = async () => {
    try {
        const q = (0, firestore_1.query)((0, firestore_1.collection)(firebase_1.db, FILMS_COLLECTION), (0, firestore_1.orderBy)('titre', 'asc'));
        const querySnapshot = await (0, firestore_1.getDocs)(q);
        const films = [];
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            films.push({
                id: doc.id,
                titre: data.titre,
                realisateur: data.realisateur,
                pays: data.pays,
                duree: data.duree,
                annee: data.annee,
                synopsis: data.synopsis,
                posterUrl: data.posterUrl,
                genre: data.genre,
                createdAt: data.createdAt.toDate(),
                updatedAt: data.updatedAt.toDate(),
            });
        });
        return films;
    }
    catch (error) {
        console.error('Erreur lors de la récupération des films:', error);
        throw error;
    }
};
exports.getAllFilms = getAllFilms;
/**
 * Récupérer un film par son ID
 */
const getFilmById = async (filmId) => {
    try {
        const docRef = (0, firestore_1.doc)(firebase_1.db, FILMS_COLLECTION, filmId);
        const docSnap = await (0, firestore_1.getDoc)(docRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            return {
                id: docSnap.id,
                titre: data.titre,
                realisateur: data.realisateur,
                pays: data.pays,
                duree: data.duree,
                annee: data.annee,
                synopsis: data.synopsis,
                posterUrl: data.posterUrl,
                genre: data.genre,
                createdAt: data.createdAt.toDate(),
                updatedAt: data.updatedAt.toDate(),
            };
        }
        return null;
    }
    catch (error) {
        console.error('Erreur lors de la récupération du film:', error);
        throw error;
    }
};
exports.getFilmById = getFilmById;
/**
 * Mettre à jour un film
 */
const updateFilm = async (filmId, data) => {
    try {
        const docRef = (0, firestore_1.doc)(firebase_1.db, FILMS_COLLECTION, filmId);
        const updateData = {
            ...data,
            updatedAt: new Date(),
        };
        // Upload du nouveau poster si fourni
        if (data.poster) {
            updateData.posterUrl = await (0, exports.uploadPoster)(data.poster);
        }
        await (0, firestore_1.updateDoc)(docRef, updateData);
    }
    catch (error) {
        console.error('Erreur lors de la mise à jour du film:', error);
        throw error;
    }
};
exports.updateFilm = updateFilm;
/**
 * Supprimer un film
 */
const deleteFilm = async (filmId) => {
    try {
        // Récupérer le film pour supprimer le poster
        const film = await (0, exports.getFilmById)(filmId);
        if (film?.posterUrl) {
            await (0, exports.deletePoster)(film.posterUrl);
        }
        const docRef = (0, firestore_1.doc)(firebase_1.db, FILMS_COLLECTION, filmId);
        await (0, firestore_1.deleteDoc)(docRef);
    }
    catch (error) {
        console.error('Erreur lors de la suppression du film:', error);
        throw error;
    }
};
exports.deleteFilm = deleteFilm;
/**
 * Upload d'un poster
 */
const uploadPoster = async (file) => {
    try {
        const fileName = `${(0, helpers_1.generateId)()}_${file.name}`;
        const storageRef = (0, storage_1.ref)(firebase_1.storage, `${POSTERS_FOLDER}/${fileName}`);
        const snapshot = await (0, storage_1.uploadBytes)(storageRef, file);
        const downloadURL = await (0, storage_1.getDownloadURL)(snapshot.ref);
        return downloadURL;
    }
    catch (error) {
        console.error('Erreur lors de l\'upload du poster:', error);
        throw error;
    }
};
exports.uploadPoster = uploadPoster;
/**
 * Supprimer un poster
 */
const deletePoster = async (posterUrl) => {
    try {
        const storageRef = (0, storage_1.ref)(firebase_1.storage, posterUrl);
        await (0, storage_1.deleteObject)(storageRef);
    }
    catch (error) {
        console.error('Erreur lors de la suppression du poster:', error);
        // Ne pas throw l'erreur car ce n'est pas critique
    }
};
exports.deletePoster = deletePoster;
/**
 * Rechercher des films
 */
const searchFilms = async (searchTerm) => {
    try {
        const films = await (0, exports.getAllFilms)();
        const term = searchTerm.toLowerCase();
        return films.filter(film => film.titre.toLowerCase().includes(term) ||
            film.realisateur.toLowerCase().includes(term) ||
            film.pays.toLowerCase().includes(term) ||
            film.genre.toLowerCase().includes(term));
    }
    catch (error) {
        console.error('Erreur lors de la recherche de films:', error);
        throw error;
    }
};
exports.searchFilms = searchFilms;
/**
 * Récupérer les films par genre
 */
const getFilmsByGenre = async (genre) => {
    try {
        const q = (0, firestore_1.query)((0, firestore_1.collection)(firebase_1.db, FILMS_COLLECTION), (0, firestore_1.where)('genre', '==', genre), (0, firestore_1.orderBy)('titre', 'asc'));
        const querySnapshot = await (0, firestore_1.getDocs)(q);
        const films = [];
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            films.push({
                id: doc.id,
                titre: data.titre,
                realisateur: data.realisateur,
                pays: data.pays,
                duree: data.duree,
                annee: data.annee,
                synopsis: data.synopsis,
                posterUrl: data.posterUrl,
                genre: data.genre,
                createdAt: data.createdAt.toDate(),
                updatedAt: data.updatedAt.toDate(),
            });
        });
        return films;
    }
    catch (error) {
        console.error('Erreur lors de la récupération des films par genre:', error);
        throw error;
    }
};
exports.getFilmsByGenre = getFilmsByGenre;
/**
 * Récupérer les films récents
 */
const getRecentFilms = async (limitCount = 10) => {
    try {
        const q = (0, firestore_1.query)((0, firestore_1.collection)(firebase_1.db, FILMS_COLLECTION), (0, firestore_1.orderBy)('createdAt', 'desc'), (0, firestore_1.limit)(limitCount));
        const querySnapshot = await (0, firestore_1.getDocs)(q);
        const films = [];
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            films.push({
                id: doc.id,
                titre: data.titre,
                realisateur: data.realisateur,
                pays: data.pays,
                duree: data.duree,
                annee: data.annee,
                synopsis: data.synopsis,
                posterUrl: data.posterUrl,
                genre: data.genre,
                createdAt: data.createdAt.toDate(),
                updatedAt: data.updatedAt.toDate(),
            });
        });
        return films;
    }
    catch (error) {
        console.error('Erreur lors de la récupération des films récents:', error);
        throw error;
    }
};
exports.getRecentFilms = getRecentFilms;
/**
 * Récupérer les statistiques des films
 */
const getFilmsStats = async () => {
    try {
        const films = await (0, exports.getAllFilms)();
        const stats = {
            total: films.length,
            parGenre: {},
            parPays: {},
            parAnnee: {},
        };
        films.forEach(film => {
            // Compter par genre
            stats.parGenre[film.genre] = (stats.parGenre[film.genre] || 0) + 1;
            // Compter par pays
            stats.parPays[film.pays] = (stats.parPays[film.pays] || 0) + 1;
            // Compter par année
            stats.parAnnee[film.annee] = (stats.parAnnee[film.annee] || 0) + 1;
        });
        return stats;
    }
    catch (error) {
        console.error('Erreur lors de la récupération des statistiques des films:', error);
        throw error;
    }
};
exports.getFilmsStats = getFilmsStats;
/**
 * Récupérer les genres disponibles
 */
const getAvailableGenres = async () => {
    try {
        const films = await (0, exports.getAllFilms)();
        const genres = Array.from(new Set(films.map(film => film.genre)));
        return genres.sort();
    }
    catch (error) {
        console.error('Erreur lors de la récupération des genres:', error);
        throw error;
    }
};
exports.getAvailableGenres = getAvailableGenres;
/**
 * Récupérer plusieurs films par leurs IDs
 */
const getFilmsByIds = async (filmIds) => {
    try {
        if (filmIds.length === 0)
            return [];
        // Récupérer les films en parallèle
        const filmPromises = filmIds.map(id => (0, exports.getFilmById)(id));
        const films = await Promise.all(filmPromises);
        // Filtrer les films null et retourner
        return films.filter((film) => film !== null);
    }
    catch (error) {
        console.error('Erreur lors de la récupération des films par IDs:', error);
        throw error;
    }
};
exports.getFilmsByIds = getFilmsByIds;
/**
 * Récupérer les pays disponibles
 */
const getAvailableCountries = async () => {
    try {
        const films = await (0, exports.getAllFilms)();
        const countries = Array.from(new Set(films.map(film => film.pays)));
        return countries.sort();
    }
    catch (error) {
        console.error('Erreur lors de la récupération des pays:', error);
        throw error;
    }
};
exports.getAvailableCountries = getAvailableCountries;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiRDpcXERvY3VtZW50c1xcYWlwcm9qZXRzXFx2b3RlcHVibGljXFxzcmNcXHNlcnZpY2VzXFxmaWxtU2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSx5Q0FBeUM7QUFDekMsa0RBWTRCO0FBQzVCLDhDQUFrRjtBQUVsRiw4Q0FBOEM7QUFFOUMsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUM7QUFDakMsTUFBTSxjQUFjLEdBQUcsU0FBUyxDQUFDO0FBRWpDOztHQUVHO0FBQ0ksTUFBTSxVQUFVLEdBQUcsS0FBSyxFQUFFLElBQW9CLEVBQWlCLEVBQUU7SUFDdEUsSUFBSSxDQUFDO1FBQ0gsSUFBSSxTQUE2QixDQUFDO1FBRWxDLDZCQUE2QjtRQUM3QixJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNoQixTQUFTLEdBQUcsTUFBTSxJQUFBLG9CQUFZLEVBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzlDLENBQUM7UUFFRCxNQUFNLFFBQVEsR0FBcUI7WUFDakMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO1lBQ2pCLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVztZQUM3QixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFDakIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO1lBQ2pCLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtZQUN2QixTQUFTO1lBQ1QsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO1lBQ2pCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtZQUNyQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7U0FDdEIsQ0FBQztRQUVGLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSxrQkFBTSxFQUFDLElBQUEsc0JBQVUsRUFBQyxhQUFFLEVBQUUsZ0JBQWdCLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUV4RSxPQUFPO1lBQ0wsRUFBRSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1lBQ2IsR0FBRyxRQUFR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cyI6W10sInNvdXJjZXMiOlsiRDpcXERvY3VtZW50c1xcYWlwcm9qZXRzXFx2b3RlcHVibGljXFxzcmNcXHNlcnZpY2VzXFxmaWxtU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkYiwgc3RvcmFnZSB9IGZyb20gJy4vZmlyZWJhc2UnO1xuaW1wb3J0IHsgXG4gIGNvbGxlY3Rpb24sIFxuICBkb2MsIFxuICBhZGREb2MsIFxuICB1cGRhdGVEb2MsIFxuICBkZWxldGVEb2MsIFxuICBnZXREb2NzLCBcbiAgZ2V0RG9jLCBcbiAgcXVlcnksIFxuICB3aGVyZSwgXG4gIG9yZGVyQnksXG4gIGxpbWl0XG59IGZyb20gJ2ZpcmViYXNlL2ZpcmVzdG9yZSc7XG5pbXBvcnQgeyByZWYsIHVwbG9hZEJ5dGVzLCBnZXREb3dubG9hZFVSTCwgZGVsZXRlT2JqZWN0IH0gZnJvbSAnZmlyZWJhc2Uvc3RvcmFnZSc7XG5pbXBvcnQgeyBGaWxtLCBDcmVhdGVGaWxtRGF0YSB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IGdlbmVyYXRlSWQgfSBmcm9tICcuLi91dGlscy9oZWxwZXJzJztcblxuY29uc3QgRklMTVNfQ09MTEVDVElPTiA9ICdmaWxtcyc7XG5jb25zdCBQT1NURVJTX0ZPTERFUiA9ICdwb3N0ZXJzJztcblxuLyoqXG4gKiBDcsOpZXIgdW4gbm91dmVhdSBmaWxtIGF2ZWMgdXBsb2FkIGR1IHBvc3RlclxuICovXG5leHBvcnQgY29uc3QgY3JlYXRlRmlsbSA9IGFzeW5jIChkYXRhOiBDcmVhdGVGaWxtRGF0YSk6IFByb21pc2U8RmlsbT4gPT4ge1xuICB0cnkge1xuICAgIGxldCBwb3N0ZXJVcmw6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICAgIC8vIFVwbG9hZCBkdSBwb3N0ZXIgc2kgZm91cm5pXG4gICAgaWYgKGRhdGEucG9zdGVyKSB7XG4gICAgICBwb3N0ZXJVcmwgPSBhd2FpdCB1cGxvYWRQb3N0ZXIoZGF0YS5wb3N0ZXIpO1xuICAgIH1cblxuICAgIGNvbnN0IGZpbG1EYXRhOiBPbWl0PEZpbG0sICdpZCc+ID0ge1xuICAgICAgdGl0cmU6IGRhdGEudGl0cmUsXG4gICAgICByZWFsaXNhdGV1cjogZGF0YS5yZWFsaXNhdGV1cixcbiAgICAgIHBheXM6IGRhdGEucGF5cyxcbiAgICAgIGR1cmVlOiBkYXRhLmR1cmVlLFxuICAgICAgYW5uZWU6IGRhdGEuYW5uZWUsXG4gICAgICBzeW5vcHNpczogZGF0YS5zeW5vcHNpcyxcbiAgICAgIHBvc3RlclVybCxcbiAgICAgIGdlbnJlOiBkYXRhLmdlbnJlLFxuICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgIH07XG5cbiAgICBjb25zdCBkb2NSZWYgPSBhd2FpdCBhZGREb2MoY29sbGVjdGlvbihkYiwgRklMTVNfQ09MTEVDVElPTiksIGZpbG1EYXRhKTtcbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IGRvY1JlZi5pZCxcbiAgICAgIC4uLmZpbG1EYXRhLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyZXVyIGxvcnMgZGUgbGEgY3LDqWF0aW9uIGR1IGZpbG06JywgZXJyb3IpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59O1xuXG4vKipcbiAqIFLDqWN1cMOpcmVyIHRvdXMgbGVzIGZpbG1zXG4gKi9cbmV4cG9ydCBjb25zdCBnZXRBbGxGaWxtcyA9IGFzeW5jICgpOiBQcm9taXNlPEZpbG1bXT4gPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHEgPSBxdWVyeShcbiAgICAgIGNvbGxlY3Rpb24oZGIsIEZJTE1TX0NPTExFQ1RJT04pLFxuICAgICAgb3JkZXJCeSgndGl0cmUnLCAnYXNjJylcbiAgICApO1xuICAgIFxuICAgIGNvbnN0IHF1ZXJ5U25hcHNob3QgPSBhd2FpdCBnZXREb2NzKHEpO1xuICAgIGNvbnN0IGZpbG1zOiBGaWxtW10gPSBbXTtcbiAgICBcbiAgICBxdWVyeVNuYXBzaG90LmZvckVhY2goKGRvYykgPT4ge1xuICAgICAgY29uc3QgZGF0YSA9IGRvYy5kYXRhKCk7XG4gICAgICBmaWxtcy5wdXNoKHtcbiAgICAgICAgaWQ6IGRvYy5pZCxcbiAgICAgICAgdGl0cmU6IGRhdGEudGl0cmUsXG4gICAgICAgIHJlYWxpc2F0ZXVyOiBkYXRhLnJlYWxpc2F0ZXVyLFxuICAgICAgICBwYXlzOiBkYXRhLnBheXMsXG4gICAgICAgIGR1cmVlOiBkYXRhLmR1cmVlLFxuICAgICAgICBhbm5lZTogZGF0YS5hbm5lZSxcbiAgICAgICAgc3lub3BzaXM6IGRhdGEuc3lub3BzaXMsXG4gICAgICAgIHBvc3RlclVybDogZGF0YS5wb3N0ZXJVcmwsXG4gICAgICAgIGdlbnJlOiBkYXRhLmdlbnJlLFxuICAgICAgICBjcmVhdGVkQXQ6IGRhdGEuY3JlYXRlZEF0LnRvRGF0ZSgpLFxuICAgICAgICB1cGRhdGVkQXQ6IGRhdGEudXBkYXRlZEF0LnRvRGF0ZSgpLFxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgXG4gICAgcmV0dXJuIGZpbG1zO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0VycmV1ciBsb3JzIGRlIGxhIHLDqWN1cMOpcmF0aW9uIGRlcyBmaWxtczonLCBlcnJvcik7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn07XG5cbi8qKlxuICogUsOpY3Vww6lyZXIgdW4gZmlsbSBwYXIgc29uIElEXG4gKi9cbmV4cG9ydCBjb25zdCBnZXRGaWxtQnlJZCA9IGFzeW5jIChmaWxtSWQ6IHN0cmluZyk6IFByb21pc2U8RmlsbSB8IG51bGw+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBkb2NSZWYgPSBkb2MoZGIsIEZJTE1TX0NPTExFQ1RJT04sIGZpbG1JZCk7XG4gICAgY29uc3QgZG9jU25hcCA9IGF3YWl0IGdldERvYyhkb2NSZWYpO1xuICAgIFxuICAgIGlmIChkb2NTbmFwLmV4aXN0cygpKSB7XG4gICAgICBjb25zdCBkYXRhID0gZG9jU25hcC5kYXRhKCk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpZDogZG9jU25hcC5pZCxcbiAgICAgICAgdGl0cmU6IGRhdGEudGl0cmUsXG4gICAgICAgIHJlYWxpc2F0ZXVyOiBkYXRhLnJlYWxpc2F0ZXVyLFxuICAgICAgICBwYXlzOiBkYXRhLnBheXMsXG4gICAgICAgIGR1cmVlOiBkYXRhLmR1cmVlLFxuICAgICAgICBhbm5lZTogZGF0YS5hbm5lZSxcbiAgICAgICAgc3lub3BzaXM6IGRhdGEuc3lub3BzaXMsXG4gICAgICAgIHBvc3RlclVybDogZGF0YS5wb3N0ZXJVcmwsXG4gICAgICAgIGdlbnJlOiBkYXRhLmdlbnJlLFxuICAgICAgICBjcmVhdGVkQXQ6IGRhdGEuY3JlYXRlZEF0LnRvRGF0ZSgpLFxuICAgICAgICB1cGRhdGVkQXQ6IGRhdGEudXBkYXRlZEF0LnRvRGF0ZSgpLFxuICAgICAgfTtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIG51bGw7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyZXVyIGxvcnMgZGUgbGEgcsOpY3Vww6lyYXRpb24gZHUgZmlsbTonLCBlcnJvcik7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn07XG5cbi8qKlxuICogTWV0dHJlIMOgIGpvdXIgdW4gZmlsbVxuICovXG5leHBvcnQgY29uc3QgdXBkYXRlRmlsbSA9IGFzeW5jIChmaWxtSWQ6IHN0cmluZywgZGF0YTogUGFydGlhbDxDcmVhdGVGaWxtRGF0YT4pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBkb2NSZWYgPSBkb2MoZGIsIEZJTE1TX0NPTExFQ1RJT04sIGZpbG1JZCk7XG4gICAgXG4gICAgY29uc3QgdXBkYXRlRGF0YTogYW55ID0ge1xuICAgICAgLi4uZGF0YSxcbiAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICB9O1xuXG4gICAgLy8gVXBsb2FkIGR1IG5vdXZlYXUgcG9zdGVyIHNpIGZvdXJuaVxuICAgIGlmIChkYXRhLnBvc3Rlcikge1xuICAgICAgdXBkYXRlRGF0YS5wb3N0ZXJVcmwgPSBhd2FpdCB1cGxvYWRQb3N0ZXIoZGF0YS5wb3N0ZXIpO1xuICAgIH1cblxuICAgIGF3YWl0IHVwZGF0ZURvYyhkb2NSZWYsIHVwZGF0ZURhdGEpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0VycmV1ciBsb3JzIGRlIGxhIG1pc2Ugw6Agam91ciBkdSBmaWxtOicsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufTtcblxuLyoqXG4gKiBTdXBwcmltZXIgdW4gZmlsbVxuICovXG5leHBvcnQgY29uc3QgZGVsZXRlRmlsbSA9IGFzeW5jIChmaWxtSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4gPT4ge1xuICB0cnkge1xuICAgIC8vIFLDqWN1cMOpcmVyIGxlIGZpbG0gcG91ciBzdXBwcmltZXIgbGUgcG9zdGVyXG4gICAgY29uc3QgZmlsbSA9IGF3YWl0IGdldEZpbG1CeUlkKGZpbG1JZCk7XG4gICAgaWYgKGZpbG0/LnBvc3RlclVybCkge1xuICAgICAgYXdhaXQgZGVsZXRlUG9zdGVyKGZpbG0ucG9zdGVyVXJsKTtcbiAgICB9XG5cbiAgICBjb25zdCBkb2NSZWYgPSBkb2MoZGIsIEZJTE1TX0NPTExFQ1RJT04sIGZpbG1JZCk7XG4gICAgYXdhaXQgZGVsZXRlRG9jKGRvY1JlZik7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyZXVyIGxvcnMgZGUgbGEgc3VwcHJlc3Npb24gZHUgZmlsbTonLCBlcnJvcik7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn07XG5cbi8qKlxuICogVXBsb2FkIGQndW4gcG9zdGVyXG4gKi9cbmV4cG9ydCBjb25zdCB1cGxvYWRQb3N0ZXIgPSBhc3luYyAoZmlsZTogRmlsZSk6IFByb21pc2U8c3RyaW5nPiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgZmlsZU5hbWUgPSBgJHtnZW5lcmF0ZUlkKCl9XyR7ZmlsZS5uYW1lfWA7XG4gICAgY29uc3Qgc3RvcmFnZVJlZiA9IHJlZihzdG9yYWdlLCBgJHtQT1NURVJTX0ZPTERFUn0vJHtmaWxlTmFtZX1gKTtcbiAgICBcbiAgICBjb25zdCBzbmFwc2hvdCA9IGF3YWl0IHVwbG9hZEJ5dGVzKHN0b3JhZ2VSZWYsIGZpbGUpO1xuICAgIGNvbnN0IGRvd25sb2FkVVJMID0gYXdhaXQgZ2V0RG93bmxvYWRVUkwoc25hcHNob3QucmVmKTtcbiAgICBcbiAgICByZXR1cm4gZG93bmxvYWRVUkw7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyZXVyIGxvcnMgZGUgbFxcJ3VwbG9hZCBkdSBwb3N0ZXI6JywgZXJyb3IpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59O1xuXG4vKipcbiAqIFN1cHByaW1lciB1biBwb3N0ZXJcbiAqL1xuZXhwb3J0IGNvbnN0IGRlbGV0ZVBvc3RlciA9IGFzeW5jIChwb3N0ZXJVcmw6IHN0cmluZyk6IFByb21pc2U8dm9pZD4gPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHN0b3JhZ2VSZWYgPSByZWYoc3RvcmFnZSwgcG9zdGVyVXJsKTtcbiAgICBhd2FpdCBkZWxldGVPYmplY3Qoc3RvcmFnZVJlZik7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyZXVyIGxvcnMgZGUgbGEgc3VwcHJlc3Npb24gZHUgcG9zdGVyOicsIGVycm9yKTtcbiAgICAvLyBOZSBwYXMgdGhyb3cgbCdlcnJldXIgY2FyIGNlIG4nZXN0IHBhcyBjcml0aXF1ZVxuICB9XG59O1xuXG4vKipcbiAqIFJlY2hlcmNoZXIgZGVzIGZpbG1zXG4gKi9cbmV4cG9ydCBjb25zdCBzZWFyY2hGaWxtcyA9IGFzeW5jIChzZWFyY2hUZXJtOiBzdHJpbmcpOiBQcm9taXNlPEZpbG1bXT4gPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGZpbG1zID0gYXdhaXQgZ2V0QWxsRmlsbXMoKTtcbiAgICBjb25zdCB0ZXJtID0gc2VhcmNoVGVybS50b0xvd2VyQ2FzZSgpO1xuICAgIFxuICAgIHJldHVybiBmaWxtcy5maWx0ZXIoZmlsbSA9PiBcbiAgICAgIGZpbG0udGl0cmUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyh0ZXJtKSB8fFxuICAgICAgZmlsbS5yZWFsaXNhdGV1ci50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHRlcm0pIHx8XG4gICAgICBmaWxtLnBheXMudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyh0ZXJtKSB8fFxuICAgICAgZmlsbS5nZW5yZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHRlcm0pXG4gICAgKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJldXIgbG9ycyBkZSBsYSByZWNoZXJjaGUgZGUgZmlsbXM6JywgZXJyb3IpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59O1xuXG4vKipcbiAqIFLDqWN1cMOpcmVyIGxlcyBmaWxtcyBwYXIgZ2VucmVcbiAqL1xuZXhwb3J0IGNvbnN0IGdldEZpbG1zQnlHZW5yZSA9IGFzeW5jIChnZW5yZTogc3RyaW5nKTogUHJvbWlzZTxGaWxtW10+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBxID0gcXVlcnkoXG4gICAgICBjb2xsZWN0aW9uKGRiLCBGSUxNU19DT0xMRUNUSU9OKSxcbiAgICAgIHdoZXJlKCdnZW5yZScsICc9PScsIGdlbnJlKSxcbiAgICAgIG9yZGVyQnkoJ3RpdHJlJywgJ2FzYycpXG4gICAgKTtcbiAgICBcbiAgICBjb25zdCBxdWVyeVNuYXBzaG90ID0gYXdhaXQgZ2V0RG9jcyhxKTtcbiAgICBjb25zdCBmaWxtczogRmlsbVtdID0gW107XG4gICAgXG4gICAgcXVlcnlTbmFwc2hvdC5mb3JFYWNoKChkb2MpID0+IHtcbiAgICAgIGNvbnN0IGRhdGEgPSBkb2MuZGF0YSgpO1xuICAgICAgZmlsbXMucHVzaCh7XG4gICAgICAgIGlkOiBkb2MuaWQsXG4gICAgICAgIHRpdHJlOiBkYXRhLnRpdHJlLFxuICAgICAgICByZWFsaXNhdGV1cjogZGF0YS5yZWFsaXNhdGV1cixcbiAgICAgICAgcGF5czogZGF0YS5wYXlzLFxuICAgICAgICBkdXJlZTogZGF0YS5kdXJlZSxcbiAgICAgICAgYW5uZWU6IGRhdGEuYW5uZWUsXG4gICAgICAgIHN5bm9wc2lzOiBkYXRhLnN5bm9wc2lzLFxuICAgICAgICBwb3N0ZXJVcmw6IGRhdGEucG9zdGVyVXJsLFxuICAgICAgICBnZW5yZTogZGF0YS5nZW5yZSxcbiAgICAgICAgY3JlYXRlZEF0OiBkYXRhLmNyZWF0ZWRBdC50b0RhdGUoKSxcbiAgICAgICAgdXBkYXRlZEF0OiBkYXRhLnVwZGF0ZWRBdC50b0RhdGUoKSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIFxuICAgIHJldHVybiBmaWxtcztcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJldXIgbG9ycyBkZSBsYSByw6ljdXDDqXJhdGlvbiBkZXMgZmlsbXMgcGFyIGdlbnJlOicsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufTtcblxuLyoqXG4gKiBSw6ljdXDDqXJlciBsZXMgZmlsbXMgcsOpY2VudHNcbiAqL1xuZXhwb3J0IGNvbnN0IGdldFJlY2VudEZpbG1zID0gYXN5bmMgKGxpbWl0Q291bnQ6IG51bWJlciA9IDEwKTogUHJvbWlzZTxGaWxtW10+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBxID0gcXVlcnkoXG4gICAgICBjb2xsZWN0aW9uKGRiLCBGSUxNU19DT0xMRUNUSU9OKSxcbiAgICAgIG9yZGVyQnkoJ2NyZWF0ZWRBdCcsICdkZXNjJyksXG4gICAgICBsaW1pdChsaW1pdENvdW50KVxuICAgICk7XG4gICAgXG4gICAgY29uc3QgcXVlcnlTbmFwc2hvdCA9IGF3YWl0IGdldERvY3MocSk7XG4gICAgY29uc3QgZmlsbXM6IEZpbG1bXSA9IFtdO1xuICAgIFxuICAgIHF1ZXJ5U25hcHNob3QuZm9yRWFjaCgoZG9jKSA9PiB7XG4gICAgICBjb25zdCBkYXRhID0gZG9jLmRhdGEoKTtcbiAgICAgIGZpbG1zLnB1c2goe1xuICAgICAgICBpZDogZG9jLmlkLFxuICAgICAgICB0aXRyZTogZGF0YS50aXRyZSxcbiAgICAgICAgcmVhbGlzYXRldXI6IGRhdGEucmVhbGlzYXRldXIsXG4gICAgICAgIHBheXM6IGRhdGEucGF5cyxcbiAgICAgICAgZHVyZWU6IGRhdGEuZHVyZWUsXG4gICAgICAgIGFubmVlOiBkYXRhLmFubmVlLFxuICAgICAgICBzeW5vcHNpczogZGF0YS5zeW5vcHNpcyxcbiAgICAgICAgcG9zdGVyVXJsOiBkYXRhLnBvc3RlclVybCxcbiAgICAgICAgZ2VucmU6IGRhdGEuZ2VucmUsXG4gICAgICAgIGNyZWF0ZWRBdDogZGF0YS5jcmVhdGVkQXQudG9EYXRlKCksXG4gICAgICAgIHVwZGF0ZWRBdDogZGF0YS51cGRhdGVkQXQudG9EYXRlKCksXG4gICAgICB9KTtcbiAgICB9KTtcbiAgICBcbiAgICByZXR1cm4gZmlsbXM7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyZXVyIGxvcnMgZGUgbGEgcsOpY3Vww6lyYXRpb24gZGVzIGZpbG1zIHLDqWNlbnRzOicsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufTtcblxuLyoqXG4gKiBSw6ljdXDDqXJlciBsZXMgc3RhdGlzdGlxdWVzIGRlcyBmaWxtc1xuICovXG5leHBvcnQgY29uc3QgZ2V0RmlsbXNTdGF0cyA9IGFzeW5jICgpOiBQcm9taXNlPHtcbiAgdG90YWw6IG51bWJlcjtcbiAgcGFyR2VucmU6IFJlY29yZDxzdHJpbmcsIG51bWJlcj47XG4gIHBhclBheXM6IFJlY29yZDxzdHJpbmcsIG51bWJlcj47XG4gIHBhckFubmVlOiBSZWNvcmQ8bnVtYmVyLCBudW1iZXI+O1xufT4gPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGZpbG1zID0gYXdhaXQgZ2V0QWxsRmlsbXMoKTtcbiAgICBcbiAgICBjb25zdCBzdGF0cyA9IHtcbiAgICAgIHRvdGFsOiBmaWxtcy5sZW5ndGgsXG4gICAgICBwYXJHZW5yZToge30gYXMgUmVjb3JkPHN0cmluZywgbnVtYmVyPixcbiAgICAgIHBhclBheXM6IHt9IGFzIFJlY29yZDxzdHJpbmcsIG51bWJlcj4sXG4gICAgICBwYXJBbm5lZToge30gYXMgUmVjb3JkPG51bWJlciwgbnVtYmVyPixcbiAgICB9O1xuICAgIFxuICAgIGZpbG1zLmZvckVhY2goZmlsbSA9PiB7XG4gICAgICAvLyBDb21wdGVyIHBhciBnZW5yZVxuICAgICAgc3RhdHMucGFyR2VucmVbZmlsbS5nZW5yZV0gPSAoc3RhdHMucGFyR2VucmVbZmlsbS5nZW5yZV0gfHwgMCkgKyAxO1xuICAgICAgXG4gICAgICAvLyBDb21wdGVyIHBhciBwYXlzXG4gICAgICBzdGF0cy5wYXJQYXlzW2ZpbG0ucGF5c10gPSAoc3RhdHMucGFyUGF5c1tmaWxtLnBheXNdIHx8IDApICsgMTtcbiAgICAgIFxuICAgICAgLy8gQ29tcHRlciBwYXIgYW5uw6llXG4gICAgICBzdGF0cy5wYXJBbm5lZVtmaWxtLmFubmVlXSA9IChzdGF0cy5wYXJBbm5lZVtmaWxtLmFubmVlXSB8fCAwKSArIDE7XG4gICAgfSk7XG4gICAgXG4gICAgcmV0dXJuIHN0YXRzO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0VycmV1ciBsb3JzIGRlIGxhIHLDqWN1cMOpcmF0aW9uIGRlcyBzdGF0aXN0aXF1ZXMgZGVzIGZpbG1zOicsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufTtcblxuLyoqXG4gKiBSw6ljdXDDqXJlciBsZXMgZ2VucmVzIGRpc3BvbmlibGVzXG4gKi9cbmV4cG9ydCBjb25zdCBnZXRBdmFpbGFibGVHZW5yZXMgPSBhc3luYyAoKTogUHJvbWlzZTxzdHJpbmdbXT4gPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGZpbG1zID0gYXdhaXQgZ2V0QWxsRmlsbXMoKTtcbiAgICBjb25zdCBnZW5yZXMgPSBBcnJheS5mcm9tKG5ldyBTZXQoZmlsbXMubWFwKGZpbG0gPT4gZmlsbS5nZW5yZSkpKTtcbiAgICByZXR1cm4gZ2VucmVzLnNvcnQoKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJldXIgbG9ycyBkZSBsYSByw6ljdXDDqXJhdGlvbiBkZXMgZ2VucmVzOicsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufTtcblxuLyoqXG4gKiBSw6ljdXDDqXJlciBwbHVzaWV1cnMgZmlsbXMgcGFyIGxldXJzIElEc1xuICovXG5leHBvcnQgY29uc3QgZ2V0RmlsbXNCeUlkcyA9IGFzeW5jIChmaWxtSWRzOiBzdHJpbmdbXSk6IFByb21pc2U8RmlsbVtdPiA9PiB7XG4gIHRyeSB7XG4gICAgaWYgKGZpbG1JZHMubGVuZ3RoID09PSAwKSByZXR1cm4gW107XG4gICAgXG4gICAgLy8gUsOpY3Vww6lyZXIgbGVzIGZpbG1zIGVuIHBhcmFsbMOobGVcbiAgICBjb25zdCBmaWxtUHJvbWlzZXMgPSBmaWxtSWRzLm1hcChpZCA9PiBnZXRGaWxtQnlJZChpZCkpO1xuICAgIGNvbnN0IGZpbG1zID0gYXdhaXQgUHJvbWlzZS5hbGwoZmlsbVByb21pc2VzKTtcbiAgICBcbiAgICAvLyBGaWx0cmVyIGxlcyBmaWxtcyBudWxsIGV0IHJldG91cm5lclxuICAgIHJldHVybiBmaWxtcy5maWx0ZXIoKGZpbG0pOiBmaWxtIGlzIEZpbG0gPT4gZmlsbSAhPT0gbnVsbCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyZXVyIGxvcnMgZGUgbGEgcsOpY3Vww6lyYXRpb24gZGVzIGZpbG1zIHBhciBJRHM6JywgZXJyb3IpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59O1xuXG4vKipcbiAqIFLDqWN1cMOpcmVyIGxlcyBwYXlzIGRpc3BvbmlibGVzXG4gKi9cbmV4cG9ydCBjb25zdCBnZXRBdmFpbGFibGVDb3VudHJpZXMgPSBhc3luYyAoKTogUHJvbWlzZTxzdHJpbmdbXT4gPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGZpbG1zID0gYXdhaXQgZ2V0QWxsRmlsbXMoKTtcbiAgICBjb25zdCBjb3VudHJpZXMgPSBBcnJheS5mcm9tKG5ldyBTZXQoZmlsbXMubWFwKGZpbG0gPT4gZmlsbS5wYXlzKSkpO1xuICAgIHJldHVybiBjb3VudHJpZXMuc29ydCgpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0VycmV1ciBsb3JzIGRlIGxhIHLDqWN1cMOpcmF0aW9uIGRlcyBwYXlzOicsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufTsgIl0sInZlcnNpb24iOjN9