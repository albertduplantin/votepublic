"use strict";(self.webpackChunkprix_du_public=self.webpackChunkprix_du_public||[]).push([[7],{1146:(e,t,r)=>{r.d(t,{Vm:()=>l});var s=r(4455),a=r(5472);r(8147),r(6925);const n="films",l=async()=>{try{const e=(0,a.P)((0,a.rJ)(s.db,n),(0,a.My)("titre","asc")),t=await(0,a.GG)(e),r=[];return t.forEach(e=>{const t=e.data();r.push({id:e.id,titre:t.titre,realisateur:t.realisateur,pays:t.pays,duree:t.duree,annee:t.annee,synopsis:t.synopsis,posterUrl:t.posterUrl,genre:t.genre,createdAt:t.createdAt.toDate(),updatedAt:t.updatedAt.toDate()})}),r}catch(e){throw console.error("Erreur lors de la r\xe9cup\xe9ration des films:",e),e}}},3458:(e,t,r)=>{r.d(t,{A:()=>s});const s=(0,r(3797).A)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]])},5168:(e,t,r)=>{r.d(t,{MS:()=>p,_M:()=>d,yc:()=>m,yq:()=>x});var s=r(5472),a=r(4455),n=r(4413),l=r(6925);let i=[],o=null,c=!1;const d=async e=>{try{var t;const r={id:(0,l.$C)(),filmId:e.filmId,seanceId:e.seanceId||"",note:e.note,commentaire:null===(t=e.commentaire)||void 0===t?void 0:t.trim(),ipAddress:await(0,l.SP)()||void 0,userAgent:(0,l.$t)(),sessionId:(0,l.f6)(),createdAt:new Date},i=(0,s.H9)((0,s.rJ)(a.db,n.I.VOTES));await(0,s.BN)(i,{...r,id:i.id})}catch(r){throw new Error("Erreur lors de l'ajout du vote")}},m=async(e,t,r,s)=>{try{var a;const n={id:(0,l.$C)(),filmId:e,seanceId:"",note:t.note,commentaire:null===(a=t.commentaire)||void 0===a?void 0:a.trim(),ipAddress:await(0,l.SP)()||void 0,userAgent:(0,l.$t)(),sessionId:s||(0,l.f6)(),createdAt:new Date};i.push(n),o||(o=window.setTimeout(()=>{u()},5e3));if(await h(e,null===r||void 0===r?void 0:r.uid,s))throw new Error("Vous avez d\xe9j\xe0 vot\xe9 pour ce film")}catch(n){throw new Error(n.message||"Erreur lors de l'ajout du vote")}},u=async()=>{if(c||0===i.length)return;c=!0;const e=[...i];i=[],o=null;try{const t=(0,s.wP)(a.db);e.forEach(e=>{const r=(0,s.H9)((0,s.rJ)(a.db,n.I.VOTES));t.set(r,{...e,id:r.id})}),await t.commit(),console.log(`${e.length} votes envoy\xe9s avec succ\xe8s`)}catch(t){console.error("Erreur lors de l'envoi du batch:",t),i.unshift(...e),setTimeout(()=>{c=!1,i.length>0&&u()},1e4)}finally{c=!1}},h=async(e,t,r)=>{try{let l;if(t)l=(0,s.P)((0,s.rJ)(a.db,n.I.VOTES),(0,s._M)("filmId","==",e),(0,s._M)("userId","==",t));else{if(!r)return!1;l=(0,s.P)((0,s.rJ)(a.db,n.I.VOTES),(0,s._M)("filmId","==",e),(0,s._M)("sessionId","==",r))}return!(await(0,s.GG)(l)).empty}catch(l){return console.error("Erreur lors de la v\xe9rification du vote:",l),!1}},x=()=>({pendingVotes:i.length,isProcessing:c,nextBatchIn:o?5e3:0}),p=async e=>{try{const t=(0,s.P)((0,s.rJ)(a.db,n.I.VOTES),(0,s._M)("seanceId","==",e),(0,s.My)("createdAt","desc")),r=await(0,s.GG)(t),l=[];r.forEach(e=>{var t;const r=e.data();l.push({...r,id:e.id,createdAt:(null===(t=r.createdAt)||void 0===t?void 0:t.toDate())||new Date})});const i={};l.forEach(e=>{i[e.filmId]||(i[e.filmId]=[]),i[e.filmId].push(e)});const o=Object.entries(i).map(e=>{let[t,r]=e;const s=r.map(e=>e.note),a={1:0,2:0,3:0,4:0,5:0};s.forEach(e=>{e>=1&&e<=5&&a[e]++});const n=s.length>0?Math.round(s.reduce((e,t)=>e+t,0)/s.length*10)/10:0;return{filmId:t,titre:"",totalVotes:r.length,moyenneNote:n,distributionNotes:a}});return{seanceId:e,totalVotes:l.length,films:o}}catch(t){throw new Error("Erreur lors de la r\xe9cup\xe9ration des r\xe9sultats de la s\xe9ance")}}},6007:(e,t,r)=>{r.r(t),r.d(t,{SeanceVotePage:()=>w});var s=r(5043),a=r(3216),n=r(880),l=r(3768),i=r(7607),o=r(3458),c=r(8112),d=r(712);const m=(0,r(3797).A)("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);var u=r(7929),h=r(5168),x=r(1146),p=r(6925),f=r(579);const y=e=>{let{variant:t="primary",size:r="md",loading:s=!1,icon:a,children:n,className:l,disabled:i,...o}=e;return(0,f.jsxs)("button",{className:(0,p.cn)("inline-flex items-center justify-center font-medium rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed",{primary:"bg-primary text-white hover:bg-primary-dark focus:ring-primary border-2 border-primary",secondary:"bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500",outline:"border-2 border-primary bg-white text-primary hover:bg-primary hover:text-white focus:ring-primary",ghost:"text-gray-700 hover:bg-gray-100 focus:ring-gray-500",danger:"bg-red-600 text-white hover:bg-red-700 focus:ring-red-500"}[t],{sm:"px-3 py-1.5 text-sm",md:"px-4 py-2 text-sm",lg:"px-6 py-3 text-base"}[r],l),disabled:i||s,...o,children:[s&&(0,f.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4",fill:"none",viewBox:"0 0 24 24",children:[(0,f.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,f.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),!s&&a&&(0,f.jsx)("span",{className:"mr-2",children:a}),n]})},g=e=>{let{children:t,className:r,padding:s="md",shadow:a="md"}=e;return(0,f.jsx)("div",{className:(0,p.cn)("bg-white rounded-lg border border-gray-200",{none:"",sm:"p-4",md:"p-6",lg:"p-8"}[s],{none:"",sm:"shadow-sm",md:"shadow-md",lg:"shadow-lg"}[a],r),children:t})};var v=r(4413);n.Ik({note:n.ai().min(1).max(5),commentaire:n.Yj().max(500).optional()});const w=()=>{const{seanceId:e}=(0,a.g)(),t=(0,a.Zp)(),[r,n]=(0,s.useState)(null),[p,w]=(0,s.useState)([]),[b,j]=(0,s.useState)(null),[N,A]=(0,s.useState)(!0),[E,I]=(0,s.useState)(!1),[S,k]=(0,s.useState)({});(0,s.useEffect)(()=>{(async()=>{if(e)try{A(!0);const[t,r,s]=await Promise.all([(0,u.Si)(e),(0,x.Vm)(),(0,h.MS)(e)]);n(t),w(r),j(s)}catch(r){l.Ay.error("Erreur lors du chargement de la s\xe9ance"),t(v.bw.VOTE)}finally{A(!1)}})()},[e,t]);const V=(e,t,r)=>{k(s=>({...s,[e]:{filmId:e,note:t,commentaire:r}}))};if(N)return(0,f.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,f.jsxs)("div",{className:"text-center",children:[(0,f.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"}),(0,f.jsx)("p",{className:"mt-4 text-gray-600",children:"Chargement de la s\xe9ance..."})]})});if(!r)return(0,f.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,f.jsxs)("div",{className:"text-center",children:[(0,f.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"S\xe9ance non trouv\xe9e"}),(0,f.jsx)(y,{onClick:()=>t(v.bw.VOTE),children:"Retour au vote"})]})});const C=p.filter(e=>r.films.includes(e.id));return(0,f.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,f.jsxs)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:[(0,f.jsxs)("div",{className:"mb-8",children:[(0,f.jsx)(y,{variant:"ghost",icon:(0,f.jsx)(i.A,{className:"h-4 w-4"}),onClick:()=>t(v.bw.VOTE),className:"mb-4",children:"Retour"}),(0,f.jsx)(g,{className:"mb-6",children:(0,f.jsxs)("div",{className:"text-center",children:[(0,f.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:r.nom}),(0,f.jsxs)("div",{className:"flex items-center justify-center space-x-6 text-gray-600",children:[(0,f.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,f.jsx)(o.A,{className:"h-4 w-4"}),(0,f.jsxs)("span",{children:[r.date.toLocaleDateString("fr-FR")," \xe0 ",r.heure]})]}),(0,f.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,f.jsx)(c.A,{className:"h-4 w-4"}),(0,f.jsxs)("span",{children:[C.length," film",C.length>1?"s":""]})]})]}),r.description&&(0,f.jsx)("p",{className:"mt-4 text-gray-600",children:r.description})]})})]}),(0,f.jsx)(g,{className:"mb-8",children:(0,f.jsxs)("div",{className:"text-center",children:[(0,f.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Votez pour les films de cette s\xe9ance"}),(0,f.jsx)("p",{className:"text-gray-600 mb-4",children:"Notez chaque film de 1 \xe0 5 \xe9toiles et ajoutez un commentaire optionnel. Vous ne pouvez voter qu'une seule fois par film."}),(0,f.jsxs)("div",{className:"flex items-center justify-center space-x-8 text-sm text-gray-500",children:[(0,f.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,f.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,f.jsx)("span",{children:"1 = Tr\xe8s mauvais"})]}),(0,f.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,f.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,f.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,f.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,f.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,f.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,f.jsx)("span",{children:"5 = Excellent"})]})]})]})}),(0,f.jsx)("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-3",children:C.map(e=>{var t;const r=S[e.id],s=null===b||void 0===b||null===(t=b.films)||void 0===t?void 0:t.find(t=>t.filmId===e.id);return(0,f.jsxs)(g,{className:"overflow-hidden",children:[(0,f.jsx)("div",{className:"aspect-[2/3] bg-gray-200 overflow-hidden",children:e.posterUrl?(0,f.jsx)("img",{src:e.posterUrl,alt:e.titre,className:"w-full h-full object-cover"}):(0,f.jsx)("div",{className:"w-full h-full flex items-center justify-center text-gray-400",children:(0,f.jsx)("span",{children:"Aucune image"})})}),(0,f.jsxs)("div",{className:"p-4",children:[(0,f.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-1",children:e.titre}),(0,f.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:e.realisateur}),(0,f.jsxs)("div",{className:"mb-4",children:[(0,f.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Votre note :"}),(0,f.jsx)("div",{className:"flex space-x-1",children:[1,2,3,4,5].map(t=>(0,f.jsx)("button",{type:"button",onClick:()=>V(e.id,t,null===r||void 0===r?void 0:r.commentaire),className:"p-1 rounded transition-colors "+((null===r||void 0===r?void 0:r.note)>=t?"text-yellow-400 hover:text-yellow-500":"text-gray-300 hover:text-yellow-400"),children:(0,f.jsx)(d.A,{className:"h-6 w-6 fill-current"})},t))}),(null===r||void 0===r?void 0:r.note)&&(0,f.jsxs)("p",{className:"text-sm text-gray-600 mt-1",children:["Note : ",r.note,"/5"]})]}),(0,f.jsxs)("div",{className:"mb-4",children:[(0,f.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Commentaire (optionnel) :"}),(0,f.jsx)("textarea",{value:(null===r||void 0===r?void 0:r.commentaire)||"",onChange:t=>V(e.id,(null===r||void 0===r?void 0:r.note)||0,t.target.value),placeholder:"Votre avis sur ce film...",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",rows:3,maxLength:500})]}),s&&(0,f.jsx)("div",{className:"border-t pt-4",children:(0,f.jsxs)("div",{className:"flex items-center justify-between text-sm text-gray-600",children:[(0,f.jsxs)("span",{children:["Moyenne : ",s.moyenne,"/5"]}),(0,f.jsxs)("span",{children:[s.totalVotes," vote",s.totalVotes>1?"s":""]})]})})]})]},e.id)})}),(0,f.jsx)("div",{className:"mt-8 text-center",children:(0,f.jsx)(y,{onClick:async()=>{if(r&&0!==Object.keys(S).length)try{I(!0);const e=Object.values(S).map(e=>(0,h._M)({filmId:e.filmId,seanceId:r.id,note:e.note,commentaire:e.commentaire}));await Promise.all(e),l.Ay.success("Votes enregistr\xe9s avec succ\xe8s !"),t(v.bw.RESULTS)}catch(e){l.Ay.error("Erreur lors de l'enregistrement des votes")}finally{I(!1)}else l.Ay.error("Veuillez voter pour au moins un film")},loading:E,disabled:0===Object.keys(S).length,icon:(0,f.jsx)(m,{className:"h-4 w-4"}),size:"lg",children:E?"Envoi en cours...":`Envoyer ${Object.keys(S).length} vote${Object.keys(S).length>1?"s":""}`})})]})})}},6925:(e,t,r)=>{r.d(t,{$C:()=>s,$t:()=>n,Lg:()=>o,SP:()=>l,ZB:()=>i,cn:()=>c,f6:()=>a});r(4413);const s=()=>Date.now().toString(36)+Math.random().toString(36).substring(2),a=()=>`${Date.now()}-${Math.random().toString(36).substring(2)}`,n=()=>navigator.userAgent,l=async()=>{try{const e=await fetch("https://api.ipify.org?format=json");return(await e.json()).ip}catch(e){return console.warn("Impossible de r\xe9cup\xe9rer l'IP:",e),null}},i=(e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.warn("Erreur lors du stockage local:",r)}},o=(e,t)=>{try{const r=localStorage.getItem(e);return r?JSON.parse(r):t}catch(r){return console.warn("Erreur lors de la r\xe9cup\xe9ration locale:",r),t}},c=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.filter(Boolean).join(" ")}},7607:(e,t,r)=>{r.d(t,{A:()=>s});const s=(0,r(3797).A)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},7929:(e,t,r)=>{r.d(t,{L6:()=>m,Si:()=>d,We:()=>h,Xb:()=>u,gc:()=>o,q5:()=>c});var s=r(4455),a=r(5472),n=r(6925);const l="seances",i="films",o=async e=>{try{if(5!==e.films.length)throw new Error("Une s\xe9ance doit contenir exactement 5 films");const t=e.films.map(e=>(0,a.x7)((0,a.H9)(s.db,i,e))),r=(await Promise.all(t)).map((t,r)=>({snapshot:t,filmId:e.films[r]})).filter(e=>{let{snapshot:t}=e;return!t.exists()});if(r.length>0)throw new Error(`Films non trouv\xe9s: ${r.map(e=>e.filmId).join(", ")}`);const o=(0,n.$C)(),c=x(o),d={nom:e.nom,description:e.description,date:e.date,heure:e.heure,films:e.films,qrCodeUrl:c,isActive:!0,createdAt:new Date,updatedAt:new Date};return{id:(await(0,a.gS)((0,a.rJ)(s.db,l),d)).id,...d}}catch(t){throw console.error("Erreur lors de la cr\xe9ation de la s\xe9ance:",t),t}},c=async()=>{try{const e=(0,a.P)((0,a.rJ)(s.db,l),(0,a.My)("date","desc")),t=await(0,a.GG)(e),r=[];return t.forEach(e=>{const t=e.data();r.push({id:e.id,nom:t.nom,description:t.description,date:t.date.toDate(),heure:t.heure,films:t.films,qrCodeUrl:t.qrCodeUrl,isActive:t.isActive,createdAt:t.createdAt.toDate(),updatedAt:t.updatedAt.toDate()})}),r}catch(e){throw console.error("Erreur lors de la r\xe9cup\xe9ration des s\xe9ances:",e),e}},d=async e=>{try{const t=(0,a.H9)(s.db,l,e),r=await(0,a.x7)(t);if(r.exists()){const e=r.data();return{id:r.id,nom:e.nom,description:e.description,date:e.date.toDate(),heure:e.heure,films:e.films,qrCodeUrl:e.qrCodeUrl,isActive:e.isActive,createdAt:e.createdAt.toDate(),updatedAt:e.updatedAt.toDate()}}return null}catch(t){throw console.error("Erreur lors de la r\xe9cup\xe9ration de la s\xe9ance:",t),t}},m=async(e,t)=>{try{const r=(0,a.H9)(s.db,l,e),n={...t,updatedAt:new Date};if(t.films&&5!==t.films.length)throw new Error("Une s\xe9ance doit contenir exactement 5 films");await(0,a.mZ)(r,n)}catch(r){throw console.error("Erreur lors de la mise \xe0 jour de la s\xe9ance:",r),r}},u=async e=>{try{const t=(0,a.H9)(s.db,l,e);await(0,a.kd)(t)}catch(t){throw console.error("Erreur lors de la suppression de la s\xe9ance:",t),t}},h=async(e,t)=>{try{const r=(0,a.H9)(s.db,l,e);await(0,a.mZ)(r,{isActive:t,updatedAt:new Date})}catch(r){throw console.error("Erreur lors de la modification du statut de la s\xe9ance:",r),r}},x=e=>{const t=window.location.origin;return`https://api.qrserver.com/v1/create-qr-code/?${new URLSearchParams({size:"300x300",data:`${t}/seance/${e}`,format:"png"}).toString()}`}}}]);
//# sourceMappingURL=7.20c5544b.chunk.js.map