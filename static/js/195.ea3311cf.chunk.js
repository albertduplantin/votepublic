"use strict";(self.webpackChunkprix_du_public=self.webpackChunkprix_du_public||[]).push([[195],{1146:(e,t,r)=>{r.d(t,{Vm:()=>i,iE:()=>c});var o=r(4455),s=r(5472),a=r(8147);r(6925);const n="films",i=async()=>{try{const e=(0,s.P)((0,s.rJ)(o.db,n),(0,s.My)("titre","asc")),t=await(0,s.GG)(e),r=[];return t.forEach(e=>{const t=e.data();r.push({id:e.id,titre:t.titre,realisateur:t.realisateur,pays:t.pays,duree:t.duree,annee:t.annee,synopsis:t.synopsis,posterUrl:t.posterUrl,genre:t.genre,createdAt:t.createdAt.toDate(),updatedAt:t.updatedAt.toDate()})}),r}catch(e){throw console.error("Erreur lors de la r\xe9cup\xe9ration des films:",e),e}},d=async e=>{try{const t=(0,s.H9)(o.db,n,e),r=await(0,s.x7)(t);if(r.exists()){const e=r.data();return{id:r.id,titre:e.titre,realisateur:e.realisateur,pays:e.pays,duree:e.duree,annee:e.annee,synopsis:e.synopsis,posterUrl:e.posterUrl,genre:e.genre,createdAt:e.createdAt.toDate(),updatedAt:e.updatedAt.toDate()}}return null}catch(t){throw console.error("Erreur lors de la r\xe9cup\xe9ration du film:",t),t}},c=async e=>{try{const t=await d(e);null!==t&&void 0!==t&&t.posterUrl&&await l(t.posterUrl);const r=(0,s.H9)(o.db,n,e);await(0,s.kd)(r)}catch(t){throw console.error("Erreur lors de la suppression du film:",t),t}},l=async e=>{try{const{storage:t}=await Promise.resolve().then(r.bind(r,4455)),o=(0,a.KR)(t,e);await(0,a.XR)(o)}catch(t){console.error("Erreur lors de la suppression du poster:",t)}}},5168:(e,t,r)=>{r.d(t,{MS:()=>y,X7:()=>m,_M:()=>l,tp:()=>w,yc:()=>u,yq:()=>f});var o=r(5472),s=r(4455),a=r(4413),n=r(6925);let i=[],d=null,c=!1;const l=async e=>{try{var t;const r=await(0,n.SP)(),i={id:(0,n.$C)(),filmId:e.filmId,seanceId:e.seanceId||"",note:e.note,userAgent:(0,n.$t)(),sessionId:(0,n.f6)(),createdAt:new Date,...(null===(t=e.commentaire)||void 0===t?void 0:t.trim())&&{commentaire:e.commentaire.trim()},...r&&{ipAddress:r},...e.userId&&{userId:e.userId}},d=(0,o.H9)((0,o.rJ)(s.db,a.I.VOTES));await(0,o.BN)(d,{...i,id:d.id})}catch(r){throw new Error("Erreur lors de l'ajout du vote")}},u=async(e,t,r,o)=>{try{var s;const a=await(0,n.SP)(),c={id:(0,n.$C)(),filmId:e,seanceId:"",note:t.note,userAgent:(0,n.$t)(),sessionId:o||(0,n.f6)(),createdAt:new Date,...(null===(s=t.commentaire)||void 0===s?void 0:s.trim())&&{commentaire:t.commentaire.trim()},...a&&{ipAddress:a},...(null===r||void 0===r?void 0:r.uid)&&{userId:r.uid}};i.push(c),d||(d=window.setTimeout(()=>{p()},5e3));if(await h(e,null===r||void 0===r?void 0:r.uid,o))throw new Error("Vous avez d\xe9j\xe0 vot\xe9 pour ce film")}catch(a){throw new Error(a.message||"Erreur lors de l'ajout du vote")}},p=async()=>{if(c||0===i.length)return;c=!0;const e=[...i];i=[],d=null;try{const t=(0,o.wP)(s.db);e.forEach(e=>{const r=(0,o.H9)((0,o.rJ)(s.db,a.I.VOTES));t.set(r,{...e,id:r.id})}),await t.commit(),console.log(`${e.length} votes envoy\xe9s avec succ\xe8s`)}catch(t){console.error("Erreur lors de l'envoi du batch:",t),i.unshift(...e),setTimeout(()=>{c=!1,i.length>0&&p()},1e4)}finally{c=!1}},h=async(e,t,r)=>{try{let i;if(t)i=(0,o.P)((0,o.rJ)(s.db,a.I.VOTES),(0,o._M)("filmId","==",e),(0,o._M)("userId","==",t));else if(r)i=(0,o.P)((0,o.rJ)(s.db,a.I.VOTES),(0,o._M)("filmId","==",e),(0,o._M)("sessionId","==",r));else{const t=await(0,n.SP)(),r=(0,n.$t)();i=(0,o.P)((0,o.rJ)(s.db,a.I.VOTES),(0,o._M)("filmId","==",e),(0,o._M)("ipAddress","==",t),(0,o._M)("userAgent","==",r))}return!(await(0,o.GG)(i)).empty}catch(i){return console.error("Erreur lors de la v\xe9rification du vote:",i),!1}},m=async(e,t,r)=>{try{let d;if(t)d=(0,o.P)((0,o.rJ)(s.db,a.I.VOTES),(0,o._M)("filmId","==",e),(0,o._M)("userId","==",t));else if(r)d=(0,o.P)((0,o.rJ)(s.db,a.I.VOTES),(0,o._M)("filmId","==",e),(0,o._M)("sessionId","==",r));else{const t=await(0,n.SP)(),r=(0,n.$t)();d=(0,o.P)((0,o.rJ)(s.db,a.I.VOTES),(0,o._M)("filmId","==",e),(0,o._M)("ipAddress","==",t),(0,o._M)("userAgent","==",r))}const c=await(0,o.GG)(d);if(!c.empty){var i;const e=c.docs[0],t=e.data();return{...t,id:e.id,createdAt:(null===(i=t.createdAt)||void 0===i?void 0:i.toDate())||new Date}}return null}catch(d){return console.error("Erreur lors de la r\xe9cup\xe9ration du vote utilisateur:",d),null}},f=()=>({pendingVotes:i.length,isProcessing:c,nextBatchIn:d?5e3:0}),w=async()=>{try{const e=(0,o.P)((0,o.rJ)(s.db,a.I.VOTES),(0,o.My)("createdAt","desc")),t=await(0,o.GG)(e),r=[];return t.forEach(e=>{var t;const o=e.data();r.push({...o,id:e.id,createdAt:(null===(t=o.createdAt)||void 0===t?void 0:t.toDate())||new Date})}),r}catch(e){throw console.error("Erreur lors de la r\xe9cup\xe9ration de tous les votes:",e),new Error("Erreur lors de la r\xe9cup\xe9ration des votes")}},y=async e=>{try{console.log(`Recherche des votes pour la s\xe9ance: ${e}`);const t=(0,o.P)((0,o.rJ)(s.db,a.I.VOTES),(0,o.My)("createdAt","desc")),r=await(0,o.GG)(t),n=[];r.forEach(e=>{var t;const r=e.data();n.push({...r,id:e.id,createdAt:(null===(t=r.createdAt)||void 0===t?void 0:t.toDate())||new Date})}),console.log(`Total des votes trouv\xe9s: ${n.length}`),console.log("Votes:",n.map(e=>({filmId:e.filmId,seanceId:e.seanceId,note:e.note})));const i={};n.forEach(e=>{i[e.filmId]||(i[e.filmId]=[]),i[e.filmId].push(e)}),console.log(`Films avec votes: ${Object.keys(i).length}`);const d=Object.entries(i).map(e=>{let[t,r]=e;const o=r.map(e=>e.note),s={1:0,2:0,3:0,4:0,5:0};o.forEach(e=>{e>=1&&e<=5&&s[e]++});const a=o.length>0?Math.round(o.reduce((e,t)=>e+t,0)/o.length*10)/10:0;return{filmId:t,titre:"",totalVotes:r.length,moyenneNote:a,distributionNotes:s}}),c=n.length;return console.log(`R\xe9sultats pour s\xe9ance ${e}: ${c} votes, ${d.length} films`),{seanceId:e,totalVotes:c,films:d}}catch(t){throw console.error("Erreur d\xe9taill\xe9e dans getSeanceResults:",t),new Error("Erreur lors de la r\xe9cup\xe9ration des r\xe9sultats de la s\xe9ance")}}},6925:(e,t,r)=>{r.d(t,{$C:()=>o,$t:()=>a,Lg:()=>d,SP:()=>n,ZB:()=>i,cn:()=>c,f6:()=>s});r(4413);const o=()=>Date.now().toString(36)+Math.random().toString(36).substring(2),s=()=>`${Date.now()}-${Math.random().toString(36).substring(2)}`,a=()=>navigator.userAgent,n=async()=>{try{const e=await fetch("https://api.ipify.org?format=json");return(await e.json()).ip}catch(e){return console.warn("Impossible de r\xe9cup\xe9rer l'IP:",e),null}},i=(e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.warn("Erreur lors du stockage local:",r)}},d=(e,t)=>{try{const r=localStorage.getItem(e);return r?JSON.parse(r):t}catch(r){return console.warn("Erreur lors de la r\xe9cup\xe9ration locale:",r),t}},c=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.filter(Boolean).join(" ")}}}]);
//# sourceMappingURL=195.ea3311cf.chunk.js.map