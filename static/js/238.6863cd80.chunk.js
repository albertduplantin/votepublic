/*! For license information please see 238.6863cd80.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkprix_du_public=self.webpackChunkprix_du_public||[]).push([[238],{1146:(e,t,r)=>{r.d(t,{Vm:()=>s,XP:()=>i,xJ:()=>d});var a=r(4455),n=r(5472);r(8147),r(6925);const o="films",s=async()=>{try{const e=(0,n.P)((0,n.rJ)(a.db,o),(0,n.My)("titre","asc")),t=await(0,n.GG)(e),r=[];return t.forEach(e=>{const t=e.data();r.push({id:e.id,titre:t.titre,realisateur:t.realisateur,pays:t.pays,duree:t.duree,annee:t.annee,synopsis:t.synopsis,posterUrl:t.posterUrl,genre:t.genre,createdAt:t.createdAt.toDate(),updatedAt:t.updatedAt.toDate()})}),r}catch(e){throw console.error("Erreur lors de la r\xe9cup\xe9ration des films:",e),e}},i=async e=>{try{const t=(0,n.H9)(a.db,o,e),r=await(0,n.x7)(t);if(r.exists()){const e=r.data();return{id:r.id,titre:e.titre,realisateur:e.realisateur,pays:e.pays,duree:e.duree,annee:e.annee,synopsis:e.synopsis,posterUrl:e.posterUrl,genre:e.genre,createdAt:e.createdAt.toDate(),updatedAt:e.updatedAt.toDate()}}return null}catch(t){throw console.error("Erreur lors de la r\xe9cup\xe9ration du film:",t),t}},d=async e=>{try{if(0===e.length)return[];const t=e.map(e=>i(e));return(await Promise.all(t)).filter(e=>null!==e)}catch(t){throw console.error("Erreur lors de la r\xe9cup\xe9ration des films par IDs:",t),t}}},5088:(e,t,r)=>{r.d(t,{A:()=>a});const a=(0,r(1639).A)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]])},5168:(e,t,r)=>{r.d(t,{MS:()=>y,X7:()=>f,_M:()=>l,yc:()=>u,yq:()=>h});var a=r(5472),n=r(4455),o=r(4413),s=r(6925);let i=[],d=null,c=!1;const l=async e=>{try{var t;const r=await(0,s.SP)(),i={id:(0,s.$C)(),filmId:e.filmId,seanceId:e.seanceId||"",note:e.note,userAgent:(0,s.$t)(),sessionId:(0,s.f6)(),createdAt:new Date,...(null===(t=e.commentaire)||void 0===t?void 0:t.trim())&&{commentaire:e.commentaire.trim()},...r&&{ipAddress:r},...e.userId&&{userId:e.userId}},d=(0,a.H9)((0,a.rJ)(n.db,o.I.VOTES));await(0,a.BN)(d,{...i,id:d.id})}catch(r){throw new Error("Erreur lors de l'ajout du vote")}},u=async(e,t,r,a)=>{try{var n;const o=await(0,s.SP)(),c={id:(0,s.$C)(),filmId:e,seanceId:"",note:t.note,userAgent:(0,s.$t)(),sessionId:a||(0,s.f6)(),createdAt:new Date,...(null===(n=t.commentaire)||void 0===n?void 0:n.trim())&&{commentaire:t.commentaire.trim()},...o&&{ipAddress:o},...(null===r||void 0===r?void 0:r.uid)&&{userId:r.uid}};i.push(c),d||(d=window.setTimeout(()=>{m()},5e3));if(await p(e,null===r||void 0===r?void 0:r.uid,a))throw new Error("Vous avez d\xe9j\xe0 vot\xe9 pour ce film")}catch(o){throw new Error(o.message||"Erreur lors de l'ajout du vote")}},m=async()=>{if(c||0===i.length)return;c=!0;const e=[...i];i=[],d=null;try{const t=(0,a.wP)(n.db);e.forEach(e=>{const r=(0,a.H9)((0,a.rJ)(n.db,o.I.VOTES));t.set(r,{...e,id:r.id})}),await t.commit(),console.log(`${e.length} votes envoy\xe9s avec succ\xe8s`)}catch(t){console.error("Erreur lors de l'envoi du batch:",t),i.unshift(...e),setTimeout(()=>{c=!1,i.length>0&&m()},1e4)}finally{c=!1}},p=async(e,t,r)=>{try{let i;if(t)i=(0,a.P)((0,a.rJ)(n.db,o.I.VOTES),(0,a._M)("filmId","==",e),(0,a._M)("userId","==",t));else if(r)i=(0,a.P)((0,a.rJ)(n.db,o.I.VOTES),(0,a._M)("filmId","==",e),(0,a._M)("sessionId","==",r));else{const t=await(0,s.SP)(),r=(0,s.$t)();i=(0,a.P)((0,a.rJ)(n.db,o.I.VOTES),(0,a._M)("filmId","==",e),(0,a._M)("ipAddress","==",t),(0,a._M)("userAgent","==",r))}return!(await(0,a.GG)(i)).empty}catch(i){return console.error("Erreur lors de la v\xe9rification du vote:",i),!1}},f=async(e,t,r)=>{try{let d;if(t)d=(0,a.P)((0,a.rJ)(n.db,o.I.VOTES),(0,a._M)("filmId","==",e),(0,a._M)("userId","==",t));else if(r)d=(0,a.P)((0,a.rJ)(n.db,o.I.VOTES),(0,a._M)("filmId","==",e),(0,a._M)("sessionId","==",r));else{const t=await(0,s.SP)(),r=(0,s.$t)();d=(0,a.P)((0,a.rJ)(n.db,o.I.VOTES),(0,a._M)("filmId","==",e),(0,a._M)("ipAddress","==",t),(0,a._M)("userAgent","==",r))}const c=await(0,a.GG)(d);if(!c.empty){var i;const e=c.docs[0],t=e.data();return{...t,id:e.id,createdAt:(null===(i=t.createdAt)||void 0===i?void 0:i.toDate())||new Date}}return null}catch(d){return console.error("Erreur lors de la r\xe9cup\xe9ration du vote utilisateur:",d),null}},h=()=>({pendingVotes:i.length,isProcessing:c,nextBatchIn:d?5e3:0}),y=async e=>{try{const t=(0,a.P)((0,a.rJ)(n.db,o.I.VOTES),(0,a._M)("seanceId","==",e),(0,a.My)("createdAt","desc")),r=await(0,a.GG)(t),s=[];r.forEach(e=>{var t;const r=e.data();s.push({...r,id:e.id,createdAt:(null===(t=r.createdAt)||void 0===t?void 0:t.toDate())||new Date})});const i={};s.forEach(e=>{i[e.filmId]||(i[e.filmId]=[]),i[e.filmId].push(e)});const d=Object.entries(i).map(e=>{let[t,r]=e;const a=r.map(e=>e.note),n={1:0,2:0,3:0,4:0,5:0};a.forEach(e=>{e>=1&&e<=5&&n[e]++});const o=a.length>0?Math.round(a.reduce((e,t)=>e+t,0)/a.length*10)/10:0;return{filmId:t,titre:"",totalVotes:r.length,moyenneNote:o,distributionNotes:n}});return{seanceId:e,totalVotes:s.length,films:d}}catch(t){throw new Error("Erreur lors de la r\xe9cup\xe9ration des r\xe9sultats de la s\xe9ance")}}},6925:(e,t,r)=>{r.d(t,{$C:()=>a,$t:()=>o,Lg:()=>d,SP:()=>s,ZB:()=>i,cn:()=>c,f6:()=>n});r(4413);const a=()=>Date.now().toString(36)+Math.random().toString(36).substring(2),n=()=>`${Date.now()}-${Math.random().toString(36).substring(2)}`,o=()=>navigator.userAgent,s=async()=>{try{const e=await fetch("https://api.ipify.org?format=json");return(await e.json()).ip}catch(e){return console.warn("Impossible de r\xe9cup\xe9rer l'IP:",e),null}},i=(e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.warn("Erreur lors du stockage local:",r)}},d=(e,t)=>{try{const r=localStorage.getItem(e);return r?JSON.parse(r):t}catch(r){return console.warn("Erreur lors de la r\xe9cup\xe9ration locale:",r),t}},c=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.filter(Boolean).join(" ")}}}]);
//# sourceMappingURL=238.6863cd80.chunk.js.map