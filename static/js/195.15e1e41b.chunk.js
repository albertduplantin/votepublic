"use strict";(self.webpackChunkprix_du_public=self.webpackChunkprix_du_public||[]).push([[195],{1146:(e,t,r)=>{r.d(t,{Vm:()=>a});var o=r(4455),s=r(5472);r(8147),r(6925);const n="films",a=async()=>{try{const e=(0,s.P)((0,s.rJ)(o.db,n),(0,s.My)("titre","asc")),t=await(0,s.GG)(e),r=[];return t.forEach(e=>{const t=e.data();r.push({id:e.id,titre:t.titre,realisateur:t.realisateur,pays:t.pays,duree:t.duree,annee:t.annee,synopsis:t.synopsis,posterUrl:t.posterUrl,genre:t.genre,createdAt:t.createdAt.toDate(),updatedAt:t.updatedAt.toDate()})}),r}catch(e){throw console.error("Erreur lors de la r\xe9cup\xe9ration des films:",e),e}}},5168:(e,t,r)=>{r.d(t,{MS:()=>g,X7:()=>f,_M:()=>l,tp:()=>I,yc:()=>u,yq:()=>p});var o=r(5472),s=r(4455),n=r(4413),a=r(6925);let d=[],i=null,c=!1;const l=async e=>{try{var t;const r=await(0,a.SP)(),d={id:(0,a.$C)(),filmId:e.filmId,seanceId:e.seanceId||"",note:e.note,userAgent:(0,a.$t)(),sessionId:(0,a.f6)(),createdAt:new Date,...(null===(t=e.commentaire)||void 0===t?void 0:t.trim())&&{commentaire:e.commentaire.trim()},...r&&{ipAddress:r},...e.userId&&{userId:e.userId}},i=(0,o.H9)((0,o.rJ)(s.db,n.I.VOTES));await(0,o.BN)(i,{...d,id:i.id})}catch(r){throw new Error("Erreur lors de l'ajout du vote")}},u=async(e,t,r,o)=>{try{var s;const n=await(0,a.SP)(),c={id:(0,a.$C)(),filmId:e,seanceId:"",note:t.note,userAgent:(0,a.$t)(),sessionId:o||(0,a.f6)(),createdAt:new Date,...(null===(s=t.commentaire)||void 0===s?void 0:s.trim())&&{commentaire:t.commentaire.trim()},...n&&{ipAddress:n},...(null===r||void 0===r?void 0:r.uid)&&{userId:r.uid}};d.push(c),i||(i=window.setTimeout(()=>{m()},5e3));if(await h(e,null===r||void 0===r?void 0:r.uid,o))throw new Error("Vous avez d\xe9j\xe0 vot\xe9 pour ce film")}catch(n){throw new Error(n.message||"Erreur lors de l'ajout du vote")}},m=async()=>{if(c||0===d.length)return;c=!0;const e=[...d];d=[],i=null;try{const t=(0,o.wP)(s.db);e.forEach(e=>{const r=(0,o.H9)((0,o.rJ)(s.db,n.I.VOTES));t.set(r,{...e,id:r.id})}),await t.commit(),console.log(`${e.length} votes envoy\xe9s avec succ\xe8s`)}catch(t){console.error("Erreur lors de l'envoi du batch:",t),d.unshift(...e),setTimeout(()=>{c=!1,d.length>0&&m()},1e4)}finally{c=!1}},h=async(e,t,r)=>{try{let d;if(t)d=(0,o.P)((0,o.rJ)(s.db,n.I.VOTES),(0,o._M)("filmId","==",e),(0,o._M)("userId","==",t));else if(r)d=(0,o.P)((0,o.rJ)(s.db,n.I.VOTES),(0,o._M)("filmId","==",e),(0,o._M)("sessionId","==",r));else{const t=await(0,a.SP)(),r=(0,a.$t)();d=(0,o.P)((0,o.rJ)(s.db,n.I.VOTES),(0,o._M)("filmId","==",e),(0,o._M)("ipAddress","==",t),(0,o._M)("userAgent","==",r))}return!(await(0,o.GG)(d)).empty}catch(d){return console.error("Erreur lors de la v\xe9rification du vote:",d),!1}},f=async(e,t,r)=>{try{let i;if(t)i=(0,o.P)((0,o.rJ)(s.db,n.I.VOTES),(0,o._M)("filmId","==",e),(0,o._M)("userId","==",t));else if(r)i=(0,o.P)((0,o.rJ)(s.db,n.I.VOTES),(0,o._M)("filmId","==",e),(0,o._M)("sessionId","==",r));else{const t=await(0,a.SP)(),r=(0,a.$t)();i=(0,o.P)((0,o.rJ)(s.db,n.I.VOTES),(0,o._M)("filmId","==",e),(0,o._M)("ipAddress","==",t),(0,o._M)("userAgent","==",r))}const c=await(0,o.GG)(i);if(!c.empty){var d;const e=c.docs[0],t=e.data();return{...t,id:e.id,createdAt:(null===(d=t.createdAt)||void 0===d?void 0:d.toDate())||new Date}}return null}catch(i){return console.error("Erreur lors de la r\xe9cup\xe9ration du vote utilisateur:",i),null}},p=()=>({pendingVotes:d.length,isProcessing:c,nextBatchIn:i?5e3:0}),I=async()=>{try{const e=(0,o.P)((0,o.rJ)(s.db,n.I.VOTES),(0,o.My)("createdAt","desc")),t=await(0,o.GG)(e),r=[];return t.forEach(e=>{var t;const o=e.data();r.push({...o,id:e.id,createdAt:(null===(t=o.createdAt)||void 0===t?void 0:t.toDate())||new Date})}),r}catch(e){throw console.error("Erreur lors de la r\xe9cup\xe9ration de tous les votes:",e),new Error("Erreur lors de la r\xe9cup\xe9ration des votes")}},g=async e=>{try{console.log(`Recherche des votes pour la s\xe9ance: ${e}`);const t=(0,o.P)((0,o.rJ)(s.db,n.I.VOTES),(0,o.My)("createdAt","desc")),r=await(0,o.GG)(t),a=[];r.forEach(e=>{var t;const r=e.data();a.push({...r,id:e.id,createdAt:(null===(t=r.createdAt)||void 0===t?void 0:t.toDate())||new Date})}),console.log(`Total des votes trouv\xe9s: ${a.length}`),console.log("Votes:",a.map(e=>({filmId:e.filmId,seanceId:e.seanceId,note:e.note})));const d={};a.forEach(e=>{d[e.filmId]||(d[e.filmId]=[]),d[e.filmId].push(e)}),console.log(`Films avec votes: ${Object.keys(d).length}`);const i=Object.entries(d).map(e=>{let[t,r]=e;const o=r.map(e=>e.note),s={1:0,2:0,3:0,4:0,5:0};o.forEach(e=>{e>=1&&e<=5&&s[e]++});const n=o.length>0?Math.round(o.reduce((e,t)=>e+t,0)/o.length*10)/10:0;return{filmId:t,titre:"",totalVotes:r.length,moyenneNote:n,distributionNotes:s}}),c=a.length;return console.log(`R\xe9sultats pour s\xe9ance ${e}: ${c} votes, ${i.length} films`),{seanceId:e,totalVotes:c,films:i}}catch(t){throw console.error("Erreur d\xe9taill\xe9e dans getSeanceResults:",t),new Error("Erreur lors de la r\xe9cup\xe9ration des r\xe9sultats de la s\xe9ance")}}},6925:(e,t,r)=>{r.d(t,{$C:()=>o,$t:()=>n,Lg:()=>i,SP:()=>a,ZB:()=>d,cn:()=>c,f6:()=>s});r(4413);const o=()=>Date.now().toString(36)+Math.random().toString(36).substring(2),s=()=>`${Date.now()}-${Math.random().toString(36).substring(2)}`,n=()=>navigator.userAgent,a=async()=>{try{const e=await fetch("https://api.ipify.org?format=json");return(await e.json()).ip}catch(e){return console.warn("Impossible de r\xe9cup\xe9rer l'IP:",e),null}},d=(e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.warn("Erreur lors du stockage local:",r)}},i=(e,t)=>{try{const r=localStorage.getItem(e);return r?JSON.parse(r):t}catch(r){return console.warn("Erreur lors de la r\xe9cup\xe9ration locale:",r),t}},c=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.filter(Boolean).join(" ")}}}]);
//# sourceMappingURL=195.15e1e41b.chunk.js.map