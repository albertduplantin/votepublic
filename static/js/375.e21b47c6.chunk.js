"use strict";(self.webpackChunkprix_du_public=self.webpackChunkprix_du_public||[]).push([[375],{1146:(e,s,t)=>{t.d(s,{Vm:()=>l});var r=t(5472),a=(t(8147),t(4455)),i=t(4413);t(6925);const l=async()=>{try{const e=(0,r.P)((0,r.rJ)(a.db,i.I.FILMS),(0,r.My)("createdAt","desc")),s=await(0,r.GG)(e),t=[];return s.forEach(e=>{var s,r;const a=e.data();t.push({id:e.id,...a,createdAt:(null===(s=a.createdAt)||void 0===s?void 0:s.toDate())||new Date,updatedAt:(null===(r=a.updatedAt)||void 0===r?void 0:r.toDate())||new Date})}),t}catch(e){throw new Error("Erreur lors de la r\xe9cup\xe9ration des films")}}},3458:(e,s,t)=>{t.d(s,{A:()=>r});const r=(0,t(3797).A)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]])},5168:(e,s,t)=>{t.d(s,{_M:()=>d,yc:()=>m,yq:()=>h});var r=t(5472),a=t(4455),i=t(4413),l=t(6925);let n=[],c=null,o=!1;const d=async e=>{try{var s;const t={id:(0,l.$C)(),filmId:e.filmId,seanceId:e.seanceId,note:e.note,commentaire:null===(s=e.commentaire)||void 0===s?void 0:s.trim(),userId:void 0,userEmail:void 0,userAgent:(0,l.$t)(),ipAddress:await(0,l.SP)()||void 0,sessionId:(0,l.f6)(),createdAt:new Date,isAnonymous:!0},n=(0,r.H9)((0,r.rJ)(a.db,i.I.VOTES));await(0,r.BN)(n,{...t,id:n.id})}catch(t){throw new Error("Erreur lors de l'ajout du vote")}},m=async(e,s,t,r)=>{try{var a;const i={id:(0,l.$C)(),filmId:e,note:s.note,commentaire:null===(a=s.commentaire)||void 0===a?void 0:a.trim(),userId:null===t||void 0===t?void 0:t.uid,userEmail:null===t||void 0===t?void 0:t.email,userAgent:(0,l.$t)(),ipAddress:await(0,l.SP)()||void 0,sessionId:r||(0,l.f6)(),createdAt:new Date,isAnonymous:!t};n.push(i),c||(c=window.setTimeout(()=>{u()},5e3));if(await x(e,null===t||void 0===t?void 0:t.uid,r))throw new Error("Vous avez d\xe9j\xe0 vot\xe9 pour ce film")}catch(i){throw new Error(i.message||"Erreur lors de l'ajout du vote")}},u=async()=>{if(o||0===n.length)return;o=!0;const e=[...n];n=[],c=null;try{const s=(0,r.wP)(a.db);e.forEach(e=>{const t=(0,r.H9)((0,r.rJ)(a.db,i.I.VOTES));s.set(t,{...e,id:t.id})}),await s.commit(),console.log(`${e.length} votes envoy\xe9s avec succ\xe8s`)}catch(s){console.error("Erreur lors de l'envoi du batch:",s),n.unshift(...e),setTimeout(()=>{o=!1,n.length>0&&u()},1e4)}finally{o=!1}},x=async(e,s,t)=>{try{let l;if(s)l=(0,r.P)((0,r.rJ)(a.db,i.I.VOTES),(0,r._M)("filmId","==",e),(0,r._M)("userId","==",s));else{if(!t)return!1;l=(0,r.P)((0,r.rJ)(a.db,i.I.VOTES),(0,r._M)("filmId","==",e),(0,r._M)("sessionId","==",t))}return!(await(0,r.GG)(l)).empty}catch(l){return console.error("Erreur lors de la v\xe9rification du vote:",l),!1}},h=()=>({pendingVotes:n.length,isProcessing:o,nextBatchIn:c?5e3:0})},6925:(e,s,t)=>{t.d(s,{$C:()=>r,$t:()=>i,Lg:()=>c,SP:()=>l,ZB:()=>n,cn:()=>o,f6:()=>a});t(4413);const r=()=>Date.now().toString(36)+Math.random().toString(36).substring(2),a=()=>`${Date.now()}-${Math.random().toString(36).substring(2)}`,i=()=>navigator.userAgent,l=async()=>{try{const e=await fetch("https://api.ipify.org?format=json");return(await e.json()).ip}catch(e){return console.warn("Impossible de r\xe9cup\xe9rer l'IP:",e),null}},n=(e,s)=>{try{localStorage.setItem(e,JSON.stringify(s))}catch(t){console.warn("Erreur lors du stockage local:",t)}},c=(e,s)=>{try{const t=localStorage.getItem(e);return t?JSON.parse(t):s}catch(t){return console.warn("Erreur lors de la r\xe9cup\xe9ration locale:",t),s}},o=function(){for(var e=arguments.length,s=new Array(e),t=0;t<e;t++)s[t]=arguments[t];return s.filter(Boolean).join(" ")}},7375:(e,s,t)=>{t.r(s),t.d(s,{VotePage:()=>j});var r=t(5043),a=t(3458),i=t(712),l=t(3797);const n=(0,l.A)("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]]),c=(0,l.A)("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["polyline",{points:"22 4 12 14.01 9 11.01",key:"6xbx8j"}]]);var o=t(4858),d=t(1850),m=t(880),u=t(3768),x=t(1146),h=t(5168),p=t(4292),v=t(6925),y=t(4413),f=t(579);const g=m.Ik({note:m.ai().min(1).max(5),commentaire:m.Yj().max(500).optional()}),j=()=>{const{user:e}=(0,p.A)(),[s,t]=(0,r.useState)([]),[l,m]=(0,r.useState)(!0),[j,b]=(0,r.useState)(null),[N,w]=(0,r.useState)({pendingVotes:0,isProcessing:!1,nextBatchIn:0}),[I]=(0,r.useState)(()=>{const e=(0,v.Lg)("voteSessionId","");if(!e){const e=(0,v.f6)();return(0,v.ZB)("voteSessionId",e),e}return e}),{register:E,handleSubmit:S,setValue:A,watch:V,formState:{errors:k,isSubmitting:C},reset:P}=(0,o.mN)({resolver:(0,d.u)(g),defaultValues:{note:0,commentaire:""}}),M=V("note");(0,r.useEffect)(()=>{(async()=>{try{const e=await(0,x.Vm)();t(e)}catch(e){u.Ay.error(y.UU.NETWORK_ERROR)}finally{m(!1)}})()},[]),(0,r.useEffect)(()=>{const e=setInterval(()=>{const e=(0,h.yq)();w(e)},1e3);return()=>clearInterval(e)},[]);return l?(0,f.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,f.jsxs)("div",{className:"text-center",children:[(0,f.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"}),(0,f.jsx)("p",{className:"mt-4 text-gray-600",children:"Chargement des films..."})]})}):(0,f.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,f.jsx)("header",{className:"bg-white shadow-sm",children:(0,f.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,f.jsxs)("div",{className:"flex justify-between items-center py-6",children:[(0,f.jsxs)("div",{children:[(0,f.jsx)("h1",{className:"text-3xl font-bold text-primary-600",children:"Voter pour un film"}),(0,f.jsx)("p",{className:"text-secondary-600 mt-1",children:"Donnez votre avis sur les films du festival"})]}),(0,f.jsxs)("div",{className:"flex items-center space-x-4",children:[N.pendingVotes>0&&(0,f.jsxs)("div",{className:"flex items-center space-x-2 text-sm text-secondary-600",children:[(0,f.jsx)(a.A,{className:"w-4 h-4"}),(0,f.jsxs)("span",{children:[N.pendingVotes," vote(s) en attente"]})]}),N.isProcessing&&(0,f.jsxs)("div",{className:"flex items-center space-x-2 text-sm text-primary-600",children:[(0,f.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-600"}),(0,f.jsx)("span",{children:"Envoi en cours..."})]})]})]})})}),(0,f.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:0===s.length?(0,f.jsxs)("div",{className:"text-center py-12",children:[(0,f.jsx)("div",{className:"text-6xl mb-4",children:"\ud83c\udfac"}),(0,f.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Aucun film disponible"}),(0,f.jsx)("p",{className:"text-gray-600",children:"Les films seront ajout\xe9s par l'administrateur."})]}):(0,f.jsxs)("div",{className:"grid lg:grid-cols-2 gap-8",children:[(0,f.jsxs)("div",{children:[(0,f.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Films en comp\xe9tition"}),(0,f.jsx)("div",{className:"space-y-4",children:s.map(e=>(0,f.jsx)("div",{className:"card cursor-pointer transition-all "+((null===j||void 0===j?void 0:j.id)===e.id?"ring-2 ring-primary-500 bg-primary-50":"hover:shadow-md"),onClick:()=>b(e),children:(0,f.jsxs)("div",{className:"flex space-x-4",children:[e.posterUrl&&(0,f.jsx)("img",{src:e.posterUrl,alt:e.titre,className:"w-16 h-24 object-cover rounded-lg"}),(0,f.jsxs)("div",{className:"flex-1",children:[(0,f.jsx)("h3",{className:"font-semibold text-gray-900",children:e.titre}),(0,f.jsxs)("p",{className:"text-sm text-gray-600 mb-2",children:["R\xe9alis\xe9 par ",e.realisateur]}),(0,f.jsx)("p",{className:"text-sm text-gray-700 line-clamp-2",children:e.synopsis})]})]})},e.id))})]}),(0,f.jsxs)("div",{children:[(0,f.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Votre vote"}),j?(0,f.jsxs)("div",{className:"card",children:[(0,f.jsxs)("div",{className:"mb-6",children:[(0,f.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:j.titre}),(0,f.jsxs)("p",{className:"text-sm text-gray-600 mb-4",children:["R\xe9alis\xe9 par ",j.realisateur]}),j.posterUrl&&(0,f.jsx)("img",{src:j.posterUrl,alt:j.titre,className:"w-full h-48 object-cover rounded-lg mb-4"}),(0,f.jsx)("p",{className:"text-gray-700",children:j.synopsis})]}),(0,f.jsxs)("form",{onSubmit:S(async s=>{if(j)try{await(0,h.yc)(j.id,s,e?{uid:e.uid,email:e.email}:null,I),u.Ay.success(y.PL.VOTE_PENDING),P(),b(null)}catch(t){u.Ay.error(t.message||y.UU.VOTE_ERROR)}else u.Ay.error("Veuillez s\xe9lectionner un film")}),className:"space-y-6",children:[(0,f.jsxs)("div",{children:[(0,f.jsx)("label",{className:"form-label",children:"Votre note"}),(0,f.jsx)("div",{className:"star-rating",children:[1,2,3,4,5].map(e=>(0,f.jsx)("button",{type:"button",onClick:()=>{A("note",e)},className:"star "+(e<=M?"star-filled":"star-empty"),children:(0,f.jsx)(i.A,{className:"w-8 h-8",fill:e<=M?"currentColor":"none"})},e))}),(0,f.jsx)("p",{className:"text-sm text-gray-600 mt-2",children:M>0?`${M}/5 \xe9toiles`:"Cliquez sur les \xe9toiles pour noter"}),k.note&&(0,f.jsx)("p",{className:"form-error",children:k.note.message})]}),(0,f.jsxs)("div",{children:[(0,f.jsxs)("label",{className:"form-label",children:[(0,f.jsx)(n,{className:"w-4 h-4 inline mr-2"}),"Commentaire (optionnel)"]}),(0,f.jsx)("textarea",{...E("commentaire"),rows:4,className:"input-field",placeholder:"Partagez votre avis sur ce film...",maxLength:500}),k.commentaire&&(0,f.jsx)("p",{className:"form-error",children:k.commentaire.message})]}),(0,f.jsx)("button",{type:"submit",disabled:C||0===M,className:"btn-primary w-full disabled:opacity-50 disabled:cursor-not-allowed",children:C?(0,f.jsxs)("div",{className:"flex items-center justify-center",children:[(0,f.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Envoi en cours..."]}):(0,f.jsxs)("div",{className:"flex items-center justify-center",children:[(0,f.jsx)(c,{className:"w-4 h-4 mr-2"}),"Envoyer mon vote"]})})]})]}):(0,f.jsxs)("div",{className:"card text-center py-12",children:[(0,f.jsx)("div",{className:"text-6xl mb-4",children:"\u2b50"}),(0,f.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"S\xe9lectionnez un film"}),(0,f.jsx)("p",{className:"text-gray-600",children:"Cliquez sur un film dans la liste pour commencer \xe0 voter"})]})]})]})})]})}}}]);
//# sourceMappingURL=375.e21b47c6.chunk.js.map