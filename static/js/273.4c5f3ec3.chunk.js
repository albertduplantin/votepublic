"use strict";(self.webpackChunkprix_du_public=self.webpackChunkprix_du_public||[]).push([[273],{146:(e,s,t)=>{t.d(s,{Vm:()=>i});var r=t(91),a=(t(147),t(455)),l=t(413);t(925);const i=async()=>{try{const e=(0,r.P)((0,r.rJ)(a.db,l.I.FILMS),(0,r.My)("createdAt","desc")),s=await(0,r.GG)(e),t=[];return s.forEach(e=>{var s,r;const a=e.data();t.push({id:e.id,...a,createdAt:(null===(s=a.createdAt)||void 0===s?void 0:s.toDate())||new Date,updatedAt:(null===(r=a.updatedAt)||void 0===r?void 0:r.toDate())||new Date})}),t}catch(e){throw new Error("Erreur lors de la r\xe9cup\xe9ration des films")}}},273:(e,s,t)=>{t.r(s),t.d(s,{VotePage:()=>I});var r=t(43),a=t(797);const l=(0,a.A)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]);var i=t(712);const n=(0,a.A)("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]]),c=(0,a.A)("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["polyline",{points:"22 4 12 14.01 9 11.01",key:"6xbx8j"}]]);var o=t(858),d=t(850),m=t(880),x=t(768),u=t(146),h=t(91),p=t(455),v=t(413),j=t(925);let y=[],f=null,g=!1;const b=async()=>{if(g||0===y.length)return;g=!0;const e=[...y];y=[],f=null;try{const s=(0,h.wP)(p.db);e.forEach(e=>{const t=(0,h.H9)((0,h.rJ)(p.db,v.I.VOTES));s.set(t,{...e,id:t.id})}),await s.commit(),console.log(`${e.length} votes envoy\xe9s avec succ\xe8s`)}catch(s){console.error("Erreur lors de l'envoi du batch:",s),y.unshift(...e),setTimeout(()=>{g=!1,y.length>0&&b()},1e4)}finally{g=!1}},N=async(e,s,t)=>{try{let r;if(s)r=(0,h.P)((0,h.rJ)(p.db,v.I.VOTES),(0,h._M)("filmId","==",e),(0,h._M)("userId","==",s));else{if(!t)return!1;r=(0,h.P)((0,h.rJ)(p.db,v.I.VOTES),(0,h._M)("filmId","==",e),(0,h._M)("sessionId","==",t))}return!(await(0,h.GG)(r)).empty}catch(r){return console.error("Erreur lors de la v\xe9rification du vote:",r),!1}};var w=t(292),E=t(579);const V=m.Ik({note:m.ai().min(1).max(5),commentaire:m.Yj().max(500).optional()}),I=()=>{const{user:e}=(0,w.A)(),[s,t]=(0,r.useState)([]),[a,m]=(0,r.useState)(!0),[h,p]=(0,r.useState)(null),[I,A]=(0,r.useState)({pendingVotes:0,isProcessing:!1,nextBatchIn:0}),[S]=(0,r.useState)(()=>{const e=(0,j.Lg)("voteSessionId","");if(!e){const e=(0,j.f6)();return(0,j.ZB)("voteSessionId",e),e}return e}),{register:k,handleSubmit:C,setValue:P,watch:_,formState:{errors:z,isSubmitting:M},reset:R}=(0,o.mN)({resolver:(0,d.u)(V),defaultValues:{note:0,commentaire:""}}),O=_("note");(0,r.useEffect)(()=>{(async()=>{try{const e=await(0,u.Vm)();t(e)}catch(e){x.Ay.error(v.UU.NETWORK_ERROR)}finally{m(!1)}})()},[]),(0,r.useEffect)(()=>{const e=setInterval(()=>{const e={pendingVotes:y.length,isProcessing:g,nextBatchIn:f?5e3:0};A(e)},1e3);return()=>clearInterval(e)},[]);return a?(0,E.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,E.jsxs)("div",{className:"text-center",children:[(0,E.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"}),(0,E.jsx)("p",{className:"mt-4 text-gray-600",children:"Chargement des films..."})]})}):(0,E.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,E.jsx)("header",{className:"bg-white shadow-sm",children:(0,E.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,E.jsxs)("div",{className:"flex justify-between items-center py-6",children:[(0,E.jsxs)("div",{children:[(0,E.jsx)("h1",{className:"text-3xl font-bold text-primary-600",children:"Voter pour un film"}),(0,E.jsx)("p",{className:"text-secondary-600 mt-1",children:"Donnez votre avis sur les films du festival"})]}),(0,E.jsxs)("div",{className:"flex items-center space-x-4",children:[I.pendingVotes>0&&(0,E.jsxs)("div",{className:"flex items-center space-x-2 text-sm text-secondary-600",children:[(0,E.jsx)(l,{className:"w-4 h-4"}),(0,E.jsxs)("span",{children:[I.pendingVotes," vote(s) en attente"]})]}),I.isProcessing&&(0,E.jsxs)("div",{className:"flex items-center space-x-2 text-sm text-primary-600",children:[(0,E.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-600"}),(0,E.jsx)("span",{children:"Envoi en cours..."})]})]})]})})}),(0,E.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:0===s.length?(0,E.jsxs)("div",{className:"text-center py-12",children:[(0,E.jsx)("div",{className:"text-6xl mb-4",children:"\ud83c\udfac"}),(0,E.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Aucun film disponible"}),(0,E.jsx)("p",{className:"text-gray-600",children:"Les films seront ajout\xe9s par l'administrateur."})]}):(0,E.jsxs)("div",{className:"grid lg:grid-cols-2 gap-8",children:[(0,E.jsxs)("div",{children:[(0,E.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Films en comp\xe9tition"}),(0,E.jsx)("div",{className:"space-y-4",children:s.map(e=>(0,E.jsx)("div",{className:"card cursor-pointer transition-all "+((null===h||void 0===h?void 0:h.id)===e.id?"ring-2 ring-primary-500 bg-primary-50":"hover:shadow-md"),onClick:()=>p(e),children:(0,E.jsxs)("div",{className:"flex space-x-4",children:[e.posterUrl&&(0,E.jsx)("img",{src:e.posterUrl,alt:e.titre,className:"w-16 h-24 object-cover rounded-lg"}),(0,E.jsxs)("div",{className:"flex-1",children:[(0,E.jsx)("h3",{className:"font-semibold text-gray-900",children:e.titre}),(0,E.jsxs)("p",{className:"text-sm text-gray-600 mb-2",children:["R\xe9alis\xe9 par ",e.realisateur]}),(0,E.jsx)("p",{className:"text-sm text-gray-700 line-clamp-2",children:e.synopsis})]})]})},e.id))})]}),(0,E.jsxs)("div",{children:[(0,E.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Votre vote"}),h?(0,E.jsxs)("div",{className:"card",children:[(0,E.jsxs)("div",{className:"mb-6",children:[(0,E.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:h.titre}),(0,E.jsxs)("p",{className:"text-sm text-gray-600 mb-4",children:["R\xe9alis\xe9 par ",h.realisateur]}),h.posterUrl&&(0,E.jsx)("img",{src:h.posterUrl,alt:h.titre,className:"w-full h-48 object-cover rounded-lg mb-4"}),(0,E.jsx)("p",{className:"text-gray-700",children:h.synopsis})]}),(0,E.jsxs)("form",{onSubmit:C(async s=>{if(h)try{await(async(e,s,t,r)=>{try{var a;const l={id:(0,j.$C)(),filmId:e,note:s.note,commentaire:null===(a=s.commentaire)||void 0===a?void 0:a.trim(),userId:null===t||void 0===t?void 0:t.uid,userEmail:null===t||void 0===t?void 0:t.email,userAgent:(0,j.$t)(),ipAddress:await(0,j.SP)()||void 0,sessionId:r||(0,j.f6)(),createdAt:new Date,isAnonymous:!t};if(y.push(l),f||(f=window.setTimeout(()=>{b()},5e3)),await N(e,null===t||void 0===t?void 0:t.uid,r))throw new Error("Vous avez d\xe9j\xe0 vot\xe9 pour ce film")}catch(l){throw new Error(l.message||"Erreur lors de l'ajout du vote")}})(h.id,s,e?{uid:e.uid,email:e.email}:null,S),x.Ay.success(v.PL.VOTE_PENDING),R(),p(null)}catch(t){x.Ay.error(t.message||v.UU.VOTE_ERROR)}else x.Ay.error("Veuillez s\xe9lectionner un film")}),className:"space-y-6",children:[(0,E.jsxs)("div",{children:[(0,E.jsx)("label",{className:"form-label",children:"Votre note"}),(0,E.jsx)("div",{className:"star-rating",children:[1,2,3,4,5].map(e=>(0,E.jsx)("button",{type:"button",onClick:()=>{P("note",e)},className:"star "+(e<=O?"star-filled":"star-empty"),children:(0,E.jsx)(i.A,{className:"w-8 h-8",fill:e<=O?"currentColor":"none"})},e))}),(0,E.jsx)("p",{className:"text-sm text-gray-600 mt-2",children:O>0?`${O}/5 \xe9toiles`:"Cliquez sur les \xe9toiles pour noter"}),z.note&&(0,E.jsx)("p",{className:"form-error",children:z.note.message})]}),(0,E.jsxs)("div",{children:[(0,E.jsxs)("label",{className:"form-label",children:[(0,E.jsx)(n,{className:"w-4 h-4 inline mr-2"}),"Commentaire (optionnel)"]}),(0,E.jsx)("textarea",{...k("commentaire"),rows:4,className:"input-field",placeholder:"Partagez votre avis sur ce film...",maxLength:500}),z.commentaire&&(0,E.jsx)("p",{className:"form-error",children:z.commentaire.message})]}),(0,E.jsx)("button",{type:"submit",disabled:M||0===O,className:"btn-primary w-full disabled:opacity-50 disabled:cursor-not-allowed",children:M?(0,E.jsxs)("div",{className:"flex items-center justify-center",children:[(0,E.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Envoi en cours..."]}):(0,E.jsxs)("div",{className:"flex items-center justify-center",children:[(0,E.jsx)(c,{className:"w-4 h-4 mr-2"}),"Envoyer mon vote"]})})]})]}):(0,E.jsxs)("div",{className:"card text-center py-12",children:[(0,E.jsx)("div",{className:"text-6xl mb-4",children:"\u2b50"}),(0,E.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"S\xe9lectionnez un film"}),(0,E.jsx)("p",{className:"text-gray-600",children:"Cliquez sur un film dans la liste pour commencer \xe0 voter"})]})]})]})})]})}}}]);
//# sourceMappingURL=273.4c5f3ec3.chunk.js.map