"use strict";(self.webpackChunkprix_du_public=self.webpackChunkprix_du_public||[]).push([[526],{1526:(e,s,t)=>{t.r(s),t.d(s,{SeanceVotePage:()=>N});var r=t(5043),a=t(3216),l=t(880),n=t(3768),i=t(7607),o=t(3458),c=t(8112),d=t(712);const m=(0,t(3797).A)("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);var u=t(4455),x=t(5472),h=t(6925);const y="seances",f="films",g=async e=>{try{const s=await(async e=>{try{const s=(0,x.H9)(u.db,y,e),t=await(0,x.x7)(s);if(t.exists()){const e=t.data();return{id:t.id,nom:e.nom,description:e.description,date:e.date.toDate(),heure:e.heure,films:e.films,qrCodeUrl:e.qrCodeUrl,isActive:e.isActive,createdAt:e.createdAt.toDate(),updatedAt:e.updatedAt.toDate()}}return null}catch(s){throw console.error("Erreur lors de la r\xe9cup\xe9ration de la s\xe9ance:",s),s}})(e);if(!s)return null;const t=s.films.map(e=>(0,x.x7)((0,x.H9)(u.db,f,e))),r=await Promise.all(t),a=[];for(const e of r)if(e.exists()){const s=e.data();s&&a.push({id:e.id,titre:s.titre,realisateur:s.realisateur,pays:s.pays,duree:s.duree,annee:s.annee,synopsis:s.synopsis,posterUrl:s.posterUrl,genre:s.genre,createdAt:s.createdAt.toDate(),updatedAt:s.updatedAt.toDate()})}return{seance:s,films:a}}catch(s){throw console.error("Erreur lors de la r\xe9cup\xe9ration de la s\xe9ance avec films:",s),s}};var p=t(5168),v=t(579);const j=e=>{let{variant:s="primary",size:t="md",loading:r=!1,icon:a,children:l,className:n,disabled:i,...o}=e;return(0,v.jsxs)("button",{className:(0,h.cn)("inline-flex items-center justify-center font-medium rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed",{primary:"bg-primary text-white hover:bg-primary-dark focus:ring-primary border-2 border-primary",secondary:"bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500",outline:"border-2 border-primary bg-white text-primary hover:bg-primary hover:text-white focus:ring-primary",ghost:"text-gray-700 hover:bg-gray-100 focus:ring-gray-500",danger:"bg-red-600 text-white hover:bg-red-700 focus:ring-red-500"}[s],{sm:"px-3 py-1.5 text-sm",md:"px-4 py-2 text-sm",lg:"px-6 py-3 text-base"}[t],n),disabled:i||r,...o,children:[r&&(0,v.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4",fill:"none",viewBox:"0 0 24 24",children:[(0,v.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,v.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),!r&&a&&(0,v.jsx)("span",{className:"mr-2",children:a}),l]})},w=e=>{let{children:s,className:t,padding:r="md",shadow:a="md"}=e;return(0,v.jsx)("div",{className:(0,h.cn)("bg-white rounded-lg border border-gray-200",{none:"",sm:"p-4",md:"p-6",lg:"p-8"}[r],{none:"",sm:"shadow-sm",md:"shadow-md",lg:"shadow-lg"}[a],t),children:s})};var b=t(4413);l.Ik({note:l.ai().min(1).max(5),commentaire:l.Yj().max(500).optional()});const N=()=>{const{seanceId:e}=(0,a.g)(),s=(0,a.Zp)(),[t,l]=(0,r.useState)(null),[u,x]=(0,r.useState)([]),[h,y]=(0,r.useState)(null),[f,N]=(0,r.useState)(!0),[A,I]=(0,r.useState)(!1),[E,S]=(0,r.useState)({});(0,r.useEffect)(()=>{(async()=>{if(e)try{N(!0);const s=await g(e);if(!s)throw new Error("S\xe9ance non trouv\xe9e");l(s.seance),x(s.films),y(null)}catch(t){n.Ay.error("Erreur lors du chargement de la s\xe9ance"),s(b.bw.VOTE)}finally{N(!1)}})()},[e,s]);const k=(e,s,t)=>{S(r=>({...r,[e]:{filmId:e,note:s,commentaire:t}}))};if(f)return(0,v.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,v.jsxs)("div",{className:"text-center",children:[(0,v.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"}),(0,v.jsx)("p",{className:"mt-4 text-gray-600",children:"Chargement de la s\xe9ance..."})]})});if(!t)return(0,v.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,v.jsxs)("div",{className:"text-center",children:[(0,v.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"S\xe9ance non trouv\xe9e"}),(0,v.jsx)(j,{onClick:()=>s(b.bw.VOTE),children:"Retour au vote"})]})});const V=u.filter(e=>t.films.includes(e.id));return(0,v.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,v.jsxs)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:[(0,v.jsxs)("div",{className:"mb-8",children:[(0,v.jsx)(j,{variant:"ghost",icon:(0,v.jsx)(i.A,{className:"h-4 w-4"}),onClick:()=>s(b.bw.VOTE),className:"mb-4",children:"Retour"}),(0,v.jsx)(w,{className:"mb-6",children:(0,v.jsxs)("div",{className:"text-center",children:[(0,v.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:t.nom}),(0,v.jsxs)("div",{className:"flex items-center justify-center space-x-6 text-gray-600",children:[(0,v.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,v.jsx)(o.A,{className:"h-4 w-4"}),(0,v.jsxs)("span",{children:[t.date.toLocaleDateString("fr-FR")," \xe0 ",t.heure]})]}),(0,v.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,v.jsx)(c.A,{className:"h-4 w-4"}),(0,v.jsxs)("span",{children:[V.length," film",V.length>1?"s":""]})]})]}),t.description&&(0,v.jsx)("p",{className:"mt-4 text-gray-600",children:t.description})]})})]}),(0,v.jsx)(w,{className:"mb-8",children:(0,v.jsxs)("div",{className:"text-center",children:[(0,v.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Votez pour les films de cette s\xe9ance"}),(0,v.jsx)("p",{className:"text-gray-600 mb-4",children:"Notez chaque film de 1 \xe0 5 \xe9toiles et ajoutez un commentaire optionnel. Vous ne pouvez voter qu'une seule fois par film."}),(0,v.jsxs)("div",{className:"flex items-center justify-center space-x-8 text-sm text-gray-500",children:[(0,v.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,v.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,v.jsx)("span",{children:"1 = Tr\xe8s mauvais"})]}),(0,v.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,v.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,v.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,v.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,v.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,v.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,v.jsx)("span",{children:"5 = Excellent"})]})]})]})}),(0,v.jsx)("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-3",children:V.map(e=>{var s;const t=E[e.id],r=null===h||void 0===h||null===(s=h.films)||void 0===s?void 0:s.find(s=>s.filmId===e.id);return(0,v.jsxs)(w,{className:"overflow-hidden",children:[(0,v.jsx)("div",{className:"aspect-[2/3] bg-gray-200 overflow-hidden",children:e.posterUrl?(0,v.jsx)("img",{src:e.posterUrl,alt:e.titre,className:"w-full h-full object-cover"}):(0,v.jsx)("div",{className:"w-full h-full flex items-center justify-center text-gray-400",children:(0,v.jsx)("span",{children:"Aucune image"})})}),(0,v.jsxs)("div",{className:"p-4",children:[(0,v.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-1",children:e.titre}),(0,v.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:e.realisateur}),(0,v.jsxs)("div",{className:"mb-4",children:[(0,v.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Votre note :"}),(0,v.jsx)("div",{className:"flex space-x-1",children:[1,2,3,4,5].map(s=>(0,v.jsx)("button",{type:"button",onClick:()=>k(e.id,s,null===t||void 0===t?void 0:t.commentaire),className:"p-1 rounded transition-colors "+((null===t||void 0===t?void 0:t.note)>=s?"text-yellow-400 hover:text-yellow-500":"text-gray-300 hover:text-yellow-400"),children:(0,v.jsx)(d.A,{className:"h-6 w-6 fill-current"})},s))}),(null===t||void 0===t?void 0:t.note)&&(0,v.jsxs)("p",{className:"text-sm text-gray-600 mt-1",children:["Note : ",t.note,"/5"]})]}),(0,v.jsxs)("div",{className:"mb-4",children:[(0,v.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Commentaire (optionnel) :"}),(0,v.jsx)("textarea",{value:(null===t||void 0===t?void 0:t.commentaire)||"",onChange:s=>k(e.id,(null===t||void 0===t?void 0:t.note)||0,s.target.value),placeholder:"Votre avis sur ce film...",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",rows:3,maxLength:500})]}),r&&(0,v.jsx)("div",{className:"border-t pt-4",children:(0,v.jsxs)("div",{className:"flex items-center justify-between text-sm text-gray-600",children:[(0,v.jsxs)("span",{children:["Moyenne : ",r.moyenne,"/5"]}),(0,v.jsxs)("span",{children:[r.totalVotes," vote",r.totalVotes>1?"s":""]})]})})]})]},e.id)})}),(0,v.jsx)("div",{className:"mt-8 text-center",children:(0,v.jsx)(j,{onClick:async()=>{if(t&&0!==Object.keys(E).length)try{I(!0);const e=Object.values(E).map(e=>(0,p._M)({filmId:e.filmId,seanceId:t.id,note:e.note,commentaire:e.commentaire}));await Promise.all(e),n.Ay.success("Votes enregistr\xe9s avec succ\xe8s !"),s(b.bw.RESULTS)}catch(e){n.Ay.error("Erreur lors de l'enregistrement des votes")}finally{I(!1)}else n.Ay.error("Veuillez voter pour au moins un film")},loading:A,disabled:0===Object.keys(E).length,icon:(0,v.jsx)(m,{className:"h-4 w-4"}),size:"lg",children:A?"Envoi en cours...":`Envoyer ${Object.keys(E).length} vote${Object.keys(E).length>1?"s":""}`})})]})})}},3458:(e,s,t)=>{t.d(s,{A:()=>r});const r=(0,t(3797).A)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]])},5168:(e,s,t)=>{t.d(s,{_M:()=>d,yc:()=>m,yq:()=>h});var r=t(5472),a=t(4455),l=t(4413),n=t(6925);let i=[],o=null,c=!1;const d=async e=>{try{var s;const t={id:(0,n.$C)(),filmId:e.filmId,seanceId:e.seanceId||"",note:e.note,commentaire:null===(s=e.commentaire)||void 0===s?void 0:s.trim(),ipAddress:await(0,n.SP)()||void 0,userAgent:(0,n.$t)(),sessionId:(0,n.f6)(),createdAt:new Date},i=(0,r.H9)((0,r.rJ)(a.db,l.I.VOTES));await(0,r.BN)(i,{...t,id:i.id})}catch(t){throw new Error("Erreur lors de l'ajout du vote")}},m=async(e,s,t,r)=>{try{var a;const l={id:(0,n.$C)(),filmId:e,seanceId:"",note:s.note,commentaire:null===(a=s.commentaire)||void 0===a?void 0:a.trim(),ipAddress:await(0,n.SP)()||void 0,userAgent:(0,n.$t)(),sessionId:r||(0,n.f6)(),createdAt:new Date};i.push(l),o||(o=window.setTimeout(()=>{u()},5e3));if(await x(e,null===t||void 0===t?void 0:t.uid,r))throw new Error("Vous avez d\xe9j\xe0 vot\xe9 pour ce film")}catch(l){throw new Error(l.message||"Erreur lors de l'ajout du vote")}},u=async()=>{if(c||0===i.length)return;c=!0;const e=[...i];i=[],o=null;try{const s=(0,r.wP)(a.db);e.forEach(e=>{const t=(0,r.H9)((0,r.rJ)(a.db,l.I.VOTES));s.set(t,{...e,id:t.id})}),await s.commit(),console.log(`${e.length} votes envoy\xe9s avec succ\xe8s`)}catch(s){console.error("Erreur lors de l'envoi du batch:",s),i.unshift(...e),setTimeout(()=>{c=!1,i.length>0&&u()},1e4)}finally{c=!1}},x=async(e,s,t)=>{try{let n;if(s)n=(0,r.P)((0,r.rJ)(a.db,l.I.VOTES),(0,r._M)("filmId","==",e),(0,r._M)("userId","==",s));else{if(!t)return!1;n=(0,r.P)((0,r.rJ)(a.db,l.I.VOTES),(0,r._M)("filmId","==",e),(0,r._M)("sessionId","==",t))}return!(await(0,r.GG)(n)).empty}catch(n){return console.error("Erreur lors de la v\xe9rification du vote:",n),!1}},h=()=>({pendingVotes:i.length,isProcessing:c,nextBatchIn:o?5e3:0})},6925:(e,s,t)=>{t.d(s,{$C:()=>r,$t:()=>l,Lg:()=>o,SP:()=>n,ZB:()=>i,cn:()=>c,f6:()=>a});t(4413);const r=()=>Date.now().toString(36)+Math.random().toString(36).substring(2),a=()=>`${Date.now()}-${Math.random().toString(36).substring(2)}`,l=()=>navigator.userAgent,n=async()=>{try{const e=await fetch("https://api.ipify.org?format=json");return(await e.json()).ip}catch(e){return console.warn("Impossible de r\xe9cup\xe9rer l'IP:",e),null}},i=(e,s)=>{try{localStorage.setItem(e,JSON.stringify(s))}catch(t){console.warn("Erreur lors du stockage local:",t)}},o=(e,s)=>{try{const t=localStorage.getItem(e);return t?JSON.parse(t):s}catch(t){return console.warn("Erreur lors de la r\xe9cup\xe9ration locale:",t),s}},c=function(){for(var e=arguments.length,s=new Array(e),t=0;t<e;t++)s[t]=arguments[t];return s.filter(Boolean).join(" ")}},7607:(e,s,t)=>{t.d(s,{A:()=>r});const r=(0,t(3797).A)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])}}]);
//# sourceMappingURL=526.f74d8361.chunk.js.map