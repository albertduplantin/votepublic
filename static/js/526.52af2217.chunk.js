"use strict";(self.webpackChunkprix_du_public=self.webpackChunkprix_du_public||[]).push([[526],{1146:(e,t,s)=>{s.d(t,{Vm:()=>n});var r=s(5472),a=(s(8147),s(4455)),l=s(4413);s(6925);const n=async()=>{try{const e=(0,r.P)((0,r.rJ)(a.db,l.I.FILMS),(0,r.My)("createdAt","desc")),t=await(0,r.GG)(e),s=[];return t.forEach(e=>{var t,r;const a=e.data();s.push({id:e.id,...a,createdAt:(null===(t=a.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(r=a.updatedAt)||void 0===r?void 0:r.toDate())||new Date})}),s}catch(e){throw new Error("Erreur lors de la r\xe9cup\xe9ration des films")}}},1526:(e,t,s)=>{s.r(t),s.d(t,{SeanceVotePage:()=>N});var r=s(5043),a=s(3216),l=s(880),n=s(3768),i=s(7607),o=s(3458),c=s(8112),d=s(712);const m=(0,s(3797).A)("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);var u=s(5472),h=s(4455),x=s(4413);const v=async e=>{try{var t,s,r;const a=await(0,u.x7)((0,u.H9)(h.db,x.I.SEANCES,e));if(!a.exists())throw new Error("S\xe9ance non trouv\xe9e");const l=a.data();return{id:a.id,...l,date:(null===(t=l.date)||void 0===t?void 0:t.toDate())||new Date,createdAt:(null===(s=l.createdAt)||void 0===s?void 0:s.toDate())||new Date,updatedAt:(null===(r=l.updatedAt)||void 0===r?void 0:r.toDate())||new Date}}catch(a){throw new Error("Erreur lors de la r\xe9cup\xe9ration de la s\xe9ance")}},y=async e=>{try{const t=await v(e),s=(0,u.P)((0,u.rJ)(h.db,x.I.VOTES),(0,u._M)("seanceId","==",e)),r=(await(0,u.GG)(s)).docs.map(e=>e.data()),a=new Map;r.forEach(e=>{a.has(e.filmId)||a.set(e.filmId,{votes:[],commentaires:[]}),a.get(e.filmId).votes.push(e.note),e.commentaire&&a.get(e.filmId).commentaires.push(e.commentaire)});const l=await Promise.all(t.films.map(async e=>{const t=(await(0,u.x7)((0,u.H9)(h.db,x.I.FILMS,e))).data(),s=a.get(e)||{votes:[],commentaires:[]},r=s.votes,l=r.length>0?r.reduce((e,t)=>e+t,0)/r.length:0,n={1:0,2:0,3:0,4:0,5:0};return r.forEach(e=>{e>=1&&e<=5&&n[e]++}),{filmId:e,titre:(null===t||void 0===t?void 0:t.titre)||"Film inconnu",realisateur:(null===t||void 0===t?void 0:t.realisateur)||"R\xe9alisateur inconnu",posterUrl:(null===t||void 0===t?void 0:t.posterUrl)||"",moyenne:Math.round(10*l)/10,totalVotes:r.length,distribution:n,commentaires:s.commentaires}}));return{seanceId:e,seanceNom:t.nom,films:l,totalVotes:r.length,dateSeance:t.date}}catch(t){throw new Error("Erreur lors de la r\xe9cup\xe9ration des r\xe9sultats")}};var g=s(1146),f=s(5168),p=s(6925),w=s(579);const j=e=>{let{variant:t="primary",size:s="md",loading:r=!1,icon:a,children:l,className:n,disabled:i,...o}=e;return(0,w.jsxs)("button",{className:(0,p.cn)("inline-flex items-center justify-center font-medium rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed",{primary:"bg-primary text-white hover:bg-primary-dark focus:ring-primary border-2 border-primary",secondary:"bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500",outline:"border-2 border-primary bg-white text-primary hover:bg-primary hover:text-white focus:ring-primary",ghost:"text-gray-700 hover:bg-gray-100 focus:ring-gray-500",danger:"bg-red-600 text-white hover:bg-red-700 focus:ring-red-500"}[t],{sm:"px-3 py-1.5 text-sm",md:"px-4 py-2 text-sm",lg:"px-6 py-3 text-base"}[s],n),disabled:i||r,...o,children:[r&&(0,w.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4",fill:"none",viewBox:"0 0 24 24",children:[(0,w.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,w.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),!r&&a&&(0,w.jsx)("span",{className:"mr-2",children:a}),l]})},b=e=>{let{children:t,className:s,padding:r="md",shadow:a="md"}=e;return(0,w.jsx)("div",{className:(0,p.cn)("bg-white rounded-lg border border-gray-200",{none:"",sm:"p-4",md:"p-6",lg:"p-8"}[r],{none:"",sm:"shadow-sm",md:"shadow-md",lg:"shadow-lg"}[a],s),children:t})},N=(l.Ik({note:l.ai().min(1).max(5),commentaire:l.Yj().max(500).optional()}),()=>{const{seanceId:e}=(0,a.g)(),t=(0,a.Zp)(),[s,l]=(0,r.useState)(null),[u,h]=(0,r.useState)([]),[p,N]=(0,r.useState)(null),[A,I]=(0,r.useState)(!0),[E,S]=(0,r.useState)(!1),[k,V]=(0,r.useState)({});(0,r.useEffect)(()=>{(async()=>{if(e)try{I(!0);const[t,s,r]=await Promise.all([v(e),(0,g.Vm)(),y(e)]);l(t),h(s),N(r)}catch(s){n.Ay.error("Erreur lors du chargement de la s\xe9ance"),t(x.bw.VOTE)}finally{I(!1)}})()},[e,t]);const M=(e,t,s)=>{V(r=>({...r,[e]:{filmId:e,note:t,commentaire:s}}))};if(A)return(0,w.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,w.jsxs)("div",{className:"text-center",children:[(0,w.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"}),(0,w.jsx)("p",{className:"mt-4 text-gray-600",children:"Chargement de la s\xe9ance..."})]})});if(!s)return(0,w.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,w.jsxs)("div",{className:"text-center",children:[(0,w.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"S\xe9ance non trouv\xe9e"}),(0,w.jsx)(j,{onClick:()=>t(x.bw.VOTE),children:"Retour au vote"})]})});const C=u.filter(e=>s.films.includes(e.id));return(0,w.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,w.jsxs)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:[(0,w.jsxs)("div",{className:"mb-8",children:[(0,w.jsx)(j,{variant:"ghost",icon:(0,w.jsx)(i.A,{className:"h-4 w-4"}),onClick:()=>t(x.bw.VOTE),className:"mb-4",children:"Retour"}),(0,w.jsx)(b,{className:"mb-6",children:(0,w.jsxs)("div",{className:"text-center",children:[(0,w.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:s.nom}),(0,w.jsxs)("div",{className:"flex items-center justify-center space-x-6 text-gray-600",children:[(0,w.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,w.jsx)(o.A,{className:"h-4 w-4"}),(0,w.jsxs)("span",{children:[s.date.toLocaleDateString("fr-FR")," \xe0 ",s.heure]})]}),(0,w.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,w.jsx)(c.A,{className:"h-4 w-4"}),(0,w.jsxs)("span",{children:[C.length," film",C.length>1?"s":""]})]})]}),s.description&&(0,w.jsx)("p",{className:"mt-4 text-gray-600",children:s.description})]})})]}),(0,w.jsx)(b,{className:"mb-8",children:(0,w.jsxs)("div",{className:"text-center",children:[(0,w.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Votez pour les films de cette s\xe9ance"}),(0,w.jsx)("p",{className:"text-gray-600 mb-4",children:"Notez chaque film de 1 \xe0 5 \xe9toiles et ajoutez un commentaire optionnel. Vous ne pouvez voter qu'une seule fois par film."}),(0,w.jsxs)("div",{className:"flex items-center justify-center space-x-8 text-sm text-gray-500",children:[(0,w.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,w.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,w.jsx)("span",{children:"1 = Tr\xe8s mauvais"})]}),(0,w.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,w.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,w.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,w.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,w.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,w.jsx)(d.A,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),(0,w.jsx)("span",{children:"5 = Excellent"})]})]})]})}),(0,w.jsx)("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-3",children:C.map(e=>{var t;const s=k[e.id],r=null===p||void 0===p||null===(t=p.films)||void 0===t?void 0:t.find(t=>t.filmId===e.id);return(0,w.jsxs)(b,{className:"overflow-hidden",children:[(0,w.jsx)("div",{className:"aspect-[2/3] bg-gray-200 overflow-hidden",children:e.posterUrl?(0,w.jsx)("img",{src:e.posterUrl,alt:e.titre,className:"w-full h-full object-cover"}):(0,w.jsx)("div",{className:"w-full h-full flex items-center justify-center text-gray-400",children:(0,w.jsx)("span",{children:"Aucune image"})})}),(0,w.jsxs)("div",{className:"p-4",children:[(0,w.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-1",children:e.titre}),(0,w.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:e.realisateur}),(0,w.jsxs)("div",{className:"mb-4",children:[(0,w.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Votre note :"}),(0,w.jsx)("div",{className:"flex space-x-1",children:[1,2,3,4,5].map(t=>(0,w.jsx)("button",{type:"button",onClick:()=>M(e.id,t,null===s||void 0===s?void 0:s.commentaire),className:"p-1 rounded transition-colors "+((null===s||void 0===s?void 0:s.note)>=t?"text-yellow-400 hover:text-yellow-500":"text-gray-300 hover:text-yellow-400"),children:(0,w.jsx)(d.A,{className:"h-6 w-6 fill-current"})},t))}),(null===s||void 0===s?void 0:s.note)&&(0,w.jsxs)("p",{className:"text-sm text-gray-600 mt-1",children:["Note : ",s.note,"/5"]})]}),(0,w.jsxs)("div",{className:"mb-4",children:[(0,w.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Commentaire (optionnel) :"}),(0,w.jsx)("textarea",{value:(null===s||void 0===s?void 0:s.commentaire)||"",onChange:t=>M(e.id,(null===s||void 0===s?void 0:s.note)||0,t.target.value),placeholder:"Votre avis sur ce film...",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",rows:3,maxLength:500})]}),r&&(0,w.jsx)("div",{className:"border-t pt-4",children:(0,w.jsxs)("div",{className:"flex items-center justify-between text-sm text-gray-600",children:[(0,w.jsxs)("span",{children:["Moyenne : ",r.moyenne,"/5"]}),(0,w.jsxs)("span",{children:[r.totalVotes," vote",r.totalVotes>1?"s":""]})]})})]})]},e.id)})}),(0,w.jsx)("div",{className:"mt-8 text-center",children:(0,w.jsx)(j,{onClick:async()=>{if(s&&0!==Object.keys(k).length)try{S(!0);const e=Object.values(k).map(e=>(0,f._M)({filmId:e.filmId,seanceId:s.id,note:e.note,commentaire:e.commentaire}));await Promise.all(e),n.Ay.success("Votes enregistr\xe9s avec succ\xe8s !"),t(x.bw.RESULTS)}catch(e){n.Ay.error("Erreur lors de l'enregistrement des votes")}finally{S(!1)}else n.Ay.error("Veuillez voter pour au moins un film")},loading:E,disabled:0===Object.keys(k).length,icon:(0,w.jsx)(m,{className:"h-4 w-4"}),size:"lg",children:E?"Envoi en cours...":`Envoyer ${Object.keys(k).length} vote${Object.keys(k).length>1?"s":""}`})})]})})})},3458:(e,t,s)=>{s.d(t,{A:()=>r});const r=(0,s(3797).A)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]])},5168:(e,t,s)=>{s.d(t,{_M:()=>d,yc:()=>m,yq:()=>x});var r=s(5472),a=s(4455),l=s(4413),n=s(6925);let i=[],o=null,c=!1;const d=async e=>{try{var t;const s={id:(0,n.$C)(),filmId:e.filmId,seanceId:e.seanceId,note:e.note,commentaire:null===(t=e.commentaire)||void 0===t?void 0:t.trim(),userId:void 0,userEmail:void 0,userAgent:(0,n.$t)(),ipAddress:await(0,n.SP)()||void 0,sessionId:(0,n.f6)(),createdAt:new Date,isAnonymous:!0},i=(0,r.H9)((0,r.rJ)(a.db,l.I.VOTES));await(0,r.BN)(i,{...s,id:i.id})}catch(s){throw new Error("Erreur lors de l'ajout du vote")}},m=async(e,t,s,r)=>{try{var a;const l={id:(0,n.$C)(),filmId:e,note:t.note,commentaire:null===(a=t.commentaire)||void 0===a?void 0:a.trim(),userId:null===s||void 0===s?void 0:s.uid,userEmail:null===s||void 0===s?void 0:s.email,userAgent:(0,n.$t)(),ipAddress:await(0,n.SP)()||void 0,sessionId:r||(0,n.f6)(),createdAt:new Date,isAnonymous:!s};i.push(l),o||(o=window.setTimeout(()=>{u()},5e3));if(await h(e,null===s||void 0===s?void 0:s.uid,r))throw new Error("Vous avez d\xe9j\xe0 vot\xe9 pour ce film")}catch(l){throw new Error(l.message||"Erreur lors de l'ajout du vote")}},u=async()=>{if(c||0===i.length)return;c=!0;const e=[...i];i=[],o=null;try{const t=(0,r.wP)(a.db);e.forEach(e=>{const s=(0,r.H9)((0,r.rJ)(a.db,l.I.VOTES));t.set(s,{...e,id:s.id})}),await t.commit(),console.log(`${e.length} votes envoy\xe9s avec succ\xe8s`)}catch(t){console.error("Erreur lors de l'envoi du batch:",t),i.unshift(...e),setTimeout(()=>{c=!1,i.length>0&&u()},1e4)}finally{c=!1}},h=async(e,t,s)=>{try{let n;if(t)n=(0,r.P)((0,r.rJ)(a.db,l.I.VOTES),(0,r._M)("filmId","==",e),(0,r._M)("userId","==",t));else{if(!s)return!1;n=(0,r.P)((0,r.rJ)(a.db,l.I.VOTES),(0,r._M)("filmId","==",e),(0,r._M)("sessionId","==",s))}return!(await(0,r.GG)(n)).empty}catch(n){return console.error("Erreur lors de la v\xe9rification du vote:",n),!1}},x=()=>({pendingVotes:i.length,isProcessing:c,nextBatchIn:o?5e3:0})},6925:(e,t,s)=>{s.d(t,{$C:()=>r,$t:()=>l,Lg:()=>o,SP:()=>n,ZB:()=>i,cn:()=>c,f6:()=>a});s(4413);const r=()=>Date.now().toString(36)+Math.random().toString(36).substring(2),a=()=>`${Date.now()}-${Math.random().toString(36).substring(2)}`,l=()=>navigator.userAgent,n=async()=>{try{const e=await fetch("https://api.ipify.org?format=json");return(await e.json()).ip}catch(e){return console.warn("Impossible de r\xe9cup\xe9rer l'IP:",e),null}},i=(e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(s){console.warn("Erreur lors du stockage local:",s)}},o=(e,t)=>{try{const s=localStorage.getItem(e);return s?JSON.parse(s):t}catch(s){return console.warn("Erreur lors de la r\xe9cup\xe9ration locale:",s),t}},c=function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return t.filter(Boolean).join(" ")}},7607:(e,t,s)=>{s.d(t,{A:()=>r});const r=(0,s(3797).A)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])}}]);
//# sourceMappingURL=526.52af2217.chunk.js.map