/*! For license information please see 948.5a487ff1.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkprix_du_public=self.webpackChunkprix_du_public||[]).push([[948],{948:(e,s,t)=>{t.r(s),t.d(s,{VotePage:()=>v});var r=t(5043),a=t(5088),n=t(3944);const l=(0,t(1639).A)("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]]);var i=t(4319),c=t(4858),o=t(1850),d=t(880),m=t(3768),u=t(1146),x=t(5168),h=t(4292),p=t(6925),y=t(4413),f=t(579);const g=d.Ik({note:d.ai().min(1).max(5),commentaire:d.Yj().max(500).optional()}),v=()=>{const{user:e}=(0,h.A)(),[s,t]=(0,r.useState)([]),[d,v]=(0,r.useState)(!0),[j,b]=(0,r.useState)(null),[N,w]=(0,r.useState)({pendingVotes:0,isProcessing:!1,nextBatchIn:0}),[I]=(0,r.useState)(()=>{const e=(0,p.Lg)("voteSessionId","");if(!e){const e=(0,p.f6)();return(0,p.ZB)("voteSessionId",e),e}return e}),{register:E,handleSubmit:A,setValue:S,watch:V,formState:{errors:P,isSubmitting:M},reset:C}=(0,c.mN)({resolver:(0,o.u)(g),defaultValues:{note:0,commentaire:""}}),D=V("note");(0,r.useEffect)(()=>{(async()=>{try{const e=await(0,u.Vm)();t(e)}catch(e){m.Ay.error(y.UU.NETWORK_ERROR)}finally{v(!1)}})()},[]),(0,r.useEffect)(()=>{const e=setInterval(()=>{const e=(0,x.yq)();w(e)},1e3);return()=>clearInterval(e)},[]);return d?(0,f.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,f.jsxs)("div",{className:"text-center",children:[(0,f.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"}),(0,f.jsx)("p",{className:"mt-4 text-gray-600",children:"Chargement des films..."})]})}):(0,f.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,f.jsx)("header",{className:"bg-white shadow-sm",children:(0,f.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,f.jsxs)("div",{className:"flex justify-between items-center py-6",children:[(0,f.jsxs)("div",{children:[(0,f.jsx)("h1",{className:"text-3xl font-bold text-primary-600",children:"Voter pour un film"}),(0,f.jsx)("p",{className:"text-secondary-600 mt-1",children:"Donnez votre avis sur les films du festival"})]}),(0,f.jsxs)("div",{className:"flex items-center space-x-4",children:[N.pendingVotes>0&&(0,f.jsxs)("div",{className:"flex items-center space-x-2 text-sm text-secondary-600",children:[(0,f.jsx)(a.A,{className:"w-4 h-4"}),(0,f.jsxs)("span",{children:[N.pendingVotes," vote(s) en attente"]})]}),N.isProcessing&&(0,f.jsxs)("div",{className:"flex items-center space-x-2 text-sm text-primary-600",children:[(0,f.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-600"}),(0,f.jsx)("span",{children:"Envoi en cours..."})]})]})]})})}),(0,f.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:0===s.length?(0,f.jsxs)("div",{className:"text-center py-12",children:[(0,f.jsx)("div",{className:"text-6xl mb-4",children:"\ud83c\udfac"}),(0,f.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Aucun film disponible"}),(0,f.jsx)("p",{className:"text-gray-600",children:"Les films seront ajout\xe9s par l'administrateur."})]}):(0,f.jsxs)("div",{className:"grid lg:grid-cols-2 gap-8",children:[(0,f.jsxs)("div",{children:[(0,f.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Films en comp\xe9tition"}),(0,f.jsx)("div",{className:"space-y-4",children:s.map(e=>(0,f.jsx)("div",{className:"card cursor-pointer transition-all "+((null===j||void 0===j?void 0:j.id)===e.id?"ring-2 ring-primary-500 bg-primary-50":"hover:shadow-md"),onClick:()=>b(e),children:(0,f.jsxs)("div",{className:"flex space-x-4",children:[e.posterUrl&&(0,f.jsx)("img",{src:e.posterUrl,alt:e.titre,className:"w-16 h-24 object-cover rounded-lg"}),(0,f.jsxs)("div",{className:"flex-1",children:[(0,f.jsx)("h3",{className:"font-semibold text-gray-900",children:e.titre}),(0,f.jsxs)("p",{className:"text-sm text-gray-600 mb-2",children:["R\xe9alis\xe9 par ",e.realisateur]}),(0,f.jsx)("p",{className:"text-sm text-gray-700 line-clamp-2",children:e.synopsis})]})]})},e.id))})]}),(0,f.jsxs)("div",{children:[(0,f.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Votre vote"}),j?(0,f.jsxs)("div",{className:"card",children:[(0,f.jsxs)("div",{className:"mb-6",children:[(0,f.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:j.titre}),(0,f.jsxs)("p",{className:"text-sm text-gray-600 mb-4",children:["R\xe9alis\xe9 par ",j.realisateur]}),j.posterUrl&&(0,f.jsx)("img",{src:j.posterUrl,alt:j.titre,className:"w-full h-48 object-cover rounded-lg mb-4"}),(0,f.jsx)("p",{className:"text-gray-700",children:j.synopsis})]}),(0,f.jsxs)("form",{onSubmit:A(async s=>{if(j)try{await(0,x.yc)(j.id,s,e?{uid:e.uid,email:e.email}:null,I),m.Ay.success(y.PL.VOTE_PENDING),C(),b(null)}catch(t){m.Ay.error(t.message||y.UU.VOTE_ERROR)}else m.Ay.error("Veuillez s\xe9lectionner un film")}),className:"space-y-6",children:[(0,f.jsxs)("div",{children:[(0,f.jsx)("label",{className:"form-label",children:"Votre note"}),(0,f.jsx)("div",{className:"star-rating",children:[1,2,3,4,5].map(e=>(0,f.jsx)("button",{type:"button",onClick:()=>{S("note",e)},className:"star "+(e<=D?"star-filled":"star-empty"),children:(0,f.jsx)(n.A,{className:"w-8 h-8",fill:e<=D?"currentColor":"none"})},e))}),(0,f.jsx)("p",{className:"text-sm text-gray-600 mt-2",children:D>0?`${D}/5 \xe9toiles`:"Cliquez sur les \xe9toiles pour noter"}),P.note&&(0,f.jsx)("p",{className:"form-error",children:P.note.message})]}),(0,f.jsxs)("div",{children:[(0,f.jsxs)("label",{className:"form-label",children:[(0,f.jsx)(l,{className:"w-4 h-4 inline mr-2"}),"Commentaire (optionnel)"]}),(0,f.jsx)("textarea",{...E("commentaire"),rows:4,className:"input-field",placeholder:"Partagez votre avis sur ce film...",maxLength:500}),P.commentaire&&(0,f.jsx)("p",{className:"form-error",children:P.commentaire.message})]}),(0,f.jsx)("button",{type:"submit",disabled:M||0===D,className:"btn-primary w-full disabled:opacity-50 disabled:cursor-not-allowed",children:M?(0,f.jsxs)("div",{className:"flex items-center justify-center",children:[(0,f.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Envoi en cours..."]}):(0,f.jsxs)("div",{className:"flex items-center justify-center",children:[(0,f.jsx)(i.A,{className:"w-4 h-4 mr-2"}),"Envoyer mon vote"]})})]})]}):(0,f.jsxs)("div",{className:"card text-center py-12",children:[(0,f.jsx)("div",{className:"text-6xl mb-4",children:"\u2b50"}),(0,f.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"S\xe9lectionnez un film"}),(0,f.jsx)("p",{className:"text-gray-600",children:"Cliquez sur un film dans la liste pour commencer \xe0 voter"})]})]})]})})]})}},1146:(e,s,t)=>{t.d(s,{Vm:()=>l,XP:()=>i,xJ:()=>c});var r=t(4455),a=t(5472);t(8147),t(6925);const n="films",l=async()=>{try{const e=(0,a.P)((0,a.rJ)(r.db,n),(0,a.My)("titre","asc")),s=await(0,a.GG)(e),t=[];return s.forEach(e=>{const s=e.data();t.push({id:e.id,titre:s.titre,realisateur:s.realisateur,pays:s.pays,duree:s.duree,annee:s.annee,synopsis:s.synopsis,posterUrl:s.posterUrl,genre:s.genre,createdAt:s.createdAt.toDate(),updatedAt:s.updatedAt.toDate()})}),t}catch(e){throw console.error("Erreur lors de la r\xe9cup\xe9ration des films:",e),e}},i=async e=>{try{const s=(0,a.H9)(r.db,n,e),t=await(0,a.x7)(s);if(t.exists()){const e=t.data();return{id:t.id,titre:e.titre,realisateur:e.realisateur,pays:e.pays,duree:e.duree,annee:e.annee,synopsis:e.synopsis,posterUrl:e.posterUrl,genre:e.genre,createdAt:e.createdAt.toDate(),updatedAt:e.updatedAt.toDate()}}return null}catch(s){throw console.error("Erreur lors de la r\xe9cup\xe9ration du film:",s),s}},c=async e=>{try{if(0===e.length)return[];const s=e.map(e=>i(e));return(await Promise.all(s)).filter(e=>null!==e)}catch(s){throw console.error("Erreur lors de la r\xe9cup\xe9ration des films par IDs:",s),s}}},5088:(e,s,t)=>{t.d(s,{A:()=>r});const r=(0,t(1639).A)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]])},5168:(e,s,t)=>{t.d(s,{MS:()=>p,_M:()=>d,yc:()=>m,yq:()=>h});var r=t(5472),a=t(4455),n=t(4413),l=t(6925);let i=[],c=null,o=!1;const d=async e=>{try{var s;const t=await(0,l.SP)(),i={id:(0,l.$C)(),filmId:e.filmId,seanceId:e.seanceId||"",note:e.note,userAgent:(0,l.$t)(),sessionId:(0,l.f6)(),createdAt:new Date,...(null===(s=e.commentaire)||void 0===s?void 0:s.trim())&&{commentaire:e.commentaire.trim()},...t&&{ipAddress:t}},c=(0,r.H9)((0,r.rJ)(a.db,n.I.VOTES));await(0,r.BN)(c,{...i,id:c.id})}catch(t){throw new Error("Erreur lors de l'ajout du vote")}},m=async(e,s,t,r)=>{try{var a;const n=await(0,l.SP)(),o={id:(0,l.$C)(),filmId:e,seanceId:"",note:s.note,userAgent:(0,l.$t)(),sessionId:r||(0,l.f6)(),createdAt:new Date,...(null===(a=s.commentaire)||void 0===a?void 0:a.trim())&&{commentaire:s.commentaire.trim()},...n&&{ipAddress:n}};i.push(o),c||(c=window.setTimeout(()=>{u()},5e3));if(await x(e,null===t||void 0===t?void 0:t.uid,r))throw new Error("Vous avez d\xe9j\xe0 vot\xe9 pour ce film")}catch(n){throw new Error(n.message||"Erreur lors de l'ajout du vote")}},u=async()=>{if(o||0===i.length)return;o=!0;const e=[...i];i=[],c=null;try{const s=(0,r.wP)(a.db);e.forEach(e=>{const t=(0,r.H9)((0,r.rJ)(a.db,n.I.VOTES));s.set(t,{...e,id:t.id})}),await s.commit(),console.log(`${e.length} votes envoy\xe9s avec succ\xe8s`)}catch(s){console.error("Erreur lors de l'envoi du batch:",s),i.unshift(...e),setTimeout(()=>{o=!1,i.length>0&&u()},1e4)}finally{o=!1}},x=async(e,s,t)=>{try{let l;if(s)l=(0,r.P)((0,r.rJ)(a.db,n.I.VOTES),(0,r._M)("filmId","==",e),(0,r._M)("userId","==",s));else{if(!t)return!1;l=(0,r.P)((0,r.rJ)(a.db,n.I.VOTES),(0,r._M)("filmId","==",e),(0,r._M)("sessionId","==",t))}return!(await(0,r.GG)(l)).empty}catch(l){return console.error("Erreur lors de la v\xe9rification du vote:",l),!1}},h=()=>({pendingVotes:i.length,isProcessing:o,nextBatchIn:c?5e3:0}),p=async e=>{try{const s=(0,r.P)((0,r.rJ)(a.db,n.I.VOTES),(0,r._M)("seanceId","==",e),(0,r.My)("createdAt","desc")),t=await(0,r.GG)(s),l=[];t.forEach(e=>{var s;const t=e.data();l.push({...t,id:e.id,createdAt:(null===(s=t.createdAt)||void 0===s?void 0:s.toDate())||new Date})});const i={};l.forEach(e=>{i[e.filmId]||(i[e.filmId]=[]),i[e.filmId].push(e)});const c=Object.entries(i).map(e=>{let[s,t]=e;const r=t.map(e=>e.note),a={1:0,2:0,3:0,4:0,5:0};r.forEach(e=>{e>=1&&e<=5&&a[e]++});const n=r.length>0?Math.round(r.reduce((e,s)=>e+s,0)/r.length*10)/10:0;return{filmId:s,titre:"",totalVotes:t.length,moyenneNote:n,distributionNotes:a}});return{seanceId:e,totalVotes:l.length,films:c}}catch(s){throw new Error("Erreur lors de la r\xe9cup\xe9ration des r\xe9sultats de la s\xe9ance")}}},6925:(e,s,t)=>{t.d(s,{$C:()=>r,$t:()=>n,Lg:()=>c,SP:()=>l,ZB:()=>i,cn:()=>o,f6:()=>a});t(4413);const r=()=>Date.now().toString(36)+Math.random().toString(36).substring(2),a=()=>`${Date.now()}-${Math.random().toString(36).substring(2)}`,n=()=>navigator.userAgent,l=async()=>{try{const e=await fetch("https://api.ipify.org?format=json");return(await e.json()).ip}catch(e){return console.warn("Impossible de r\xe9cup\xe9rer l'IP:",e),null}},i=(e,s)=>{try{localStorage.setItem(e,JSON.stringify(s))}catch(t){console.warn("Erreur lors du stockage local:",t)}},c=(e,s)=>{try{const t=localStorage.getItem(e);return t?JSON.parse(t):s}catch(t){return console.warn("Erreur lors de la r\xe9cup\xe9ration locale:",t),s}},o=function(){for(var e=arguments.length,s=new Array(e),t=0;t<e;t++)s[t]=arguments[t];return s.filter(Boolean).join(" ")}}}]);
//# sourceMappingURL=948.5a487ff1.chunk.js.map